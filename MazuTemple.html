<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·šä¸Šåª½ç¥–éˆç±¤ | æ™ºæ…§æŒ‡å¼•ç‰ˆ</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ React èˆ‡ ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- å¼•å…¥ Babel ç”¨æ–¼è§£æ JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* å¼•å…¥è¥¯ç·šå­—é«”ï¼Œå¢åŠ å®®å»Ÿæ°›åœ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Serif TC', serif; }
        
        /* 3D ç¿»è½‰å‹•ç•« */
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-x-180 { transform: rotateX(180deg); }
        .writing-vertical { writing-mode: vertical-rl; }
        
        /* æ“²ç­Šå‹•ç•« */
        @keyframes toss-left { 
            0% { transform: translateY(0) rotateX(0) rotateZ(0); } 
            50% { transform: translateY(-150px) rotateX(720deg) rotateZ(-30deg); } 
            100% { transform: translateY(0) rotateX(var(--rotate-end-left)) rotateZ(15deg); } 
        }
        @keyframes toss-right { 
            0% { transform: translateY(0) rotateX(0) rotateZ(0); } 
            50% { transform: translateY(-150px) rotateX(720deg) rotateZ(30deg); } 
            100% { transform: translateY(0) rotateX(var(--rotate-end-right)) rotateZ(-15deg); } 
        }
        .animate-toss-left { animation: toss-left 1.5s ease-out forwards; }
        .animate-toss-right { animation: toss-right 1.5s ease-out forwards; }
        
        /* æ–ç±¤å‹•ç•« */
        @keyframes container-shake { 
            0%, 100% { transform: rotate(0deg); } 
            25% { transform: rotate(-5deg) translateY(-5px); } 
            75% { transform: rotate(5deg) translateY(-5px); } 
        }
        .animate-shake-hard { animation: container-shake 0.1s infinite; }
        
        /* æ·¡å…¥å‹•ç•« */
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        
        /* éš±è— Canvas */
        .hidden { display: none; }
    </style>
</head>
<body class="bg-stone-900 text-yellow-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- åœ–ç¤ºçµ„ä»¶ (SVG) ---
        const IconBase = ({ d, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d={d} />
            </svg>
        );
        const User = (props) => <IconBase {...props} d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2 M12 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8z" />;
        const Star = (props) => <IconBase {...props} d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />;
        const RotateCcw = (props) => <IconBase {...props} d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8 M3 3v5h5" />;
        const Download = (props) => <IconBase {...props} d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M7 10l5 5 5-5 M12 15V3" />;
        const X = (props) => <IconBase {...props} d="M18 6L6 18 M6 6l12 12" />;
        const Sparkles = (props) => <IconBase {...props} d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z" />;
        const Flower = (props) => <IconBase {...props} d="M12 7.5a4.5 4.5 0 1 1 4.5 4.5M12 7.5A4.5 4.5 0 1 0 7.5 12M12 7.5V9m-4.5 3a4.5 4.5 0 1 1 4.5-4.5M7.5 12H9m3 4.5a4.5 4.5 0 1 1-4.5-4.5M12 16.5v-1.5m4.5-3a4.5 4.5 0 1 1-4.5 4.5M16.5 12H15" />; // Simplified Flower
        const Heart = (props) => <IconBase {...props} d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />;
        const Lock = (props) => <IconBase {...props} d="M19 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2Zm-5 0V7a4 4 0 1 0-8 0v4" />;
        const ListOrdered = (props) => <IconBase {...props} d="M10 6h11M10 12h11M10 18h11M4 6h1M4 12h1M4 18h1" />;
        const Hand = (props) => <IconBase {...props} d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0 M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2 M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8 M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15" />;
        const Move = (props) => <IconBase {...props} d="M5 9l-3 3 3 3M9 5l3-3 3 3M19 9l3 3-3 3M9 19l3 3 3-3M2 12h20M12 2v20" />;

        // --- è³‡æ–™åº« ---
        // (å®Œæ•´ 60 é¦–é‚è¼¯ï¼Œé€™è£¡ä½¿ç”¨ç”Ÿæˆé‚è¼¯æ¨¡æ“¬ï¼Œå¯¦éš›ä½¿ç”¨æ™‚å¯å±•é–‹ç‚ºå®Œæ•´ JSON)
        const LOTS_DATA = [
            {id:1,t:'ç”²å­',l:'å¤§å‰',s:'åŒ…å…¬è«‹é›·é©šä»å®—',p:['æ—¥å‡ºä¾¿è¦‹é¢¨é›²æ•£','å…‰æ˜æ¸…æ·¨ç…§ä¸–é–“','ä¸€å‘å‰é€”é€šå¤§é“','è¬äº‹æ¸…å‰ä¿å¹³å®‰'],j:{åŠŸå:'é¡¯æ¦®',æœˆä»¤:'æœˆåœ“',å©šå§»:'æˆè€…',è²¡åˆ©:'ååˆ†',æ²»ç—…:'ç—Šç™’',å°‹äºº:'å¾—å›',å®˜äº‹:'æœ‰ç†',å®¶é‹:'å¹³å®‰'},m:'æ’¥é›²è¦‹æ—¥'},
            {id:2,t:'ç”²å¯…',l:'ä¸­å‰',s:'æ–¼ä»Šæ­¤æ™¯æ­£ç•¶æ™‚',p:['æ–¼ä»Šæ­¤æ™¯æ­£ç•¶æ™‚','çœ‹çœ‹æ¬²åç™¾èŠ±é­','è‹¥èƒ½é‡å¾—æ˜¥è‰²åˆ°','ä¸€ç‘æ¸…å‰è„«å¡µåŸƒ'],j:{åŠŸå:'æœ‰è²´',æœˆä»¤:'å¹³å¹³',å©šå§»:'å’Œåˆ',è²¡åˆ©:'æ™šæˆ',æ²»ç—…:'æ˜¥ç™’',å°‹äºº:'å—æ–¹',å®˜äº‹:'å‹è¨´',å®¶é‹:'æ¼¸èˆˆ'},m:'æ˜¥æš–èŠ±é–‹'},
            {id:3,t:'ä¹™ä¸‘',l:'ä¸‹ä¸‹',s:'å­Ÿå§œå¥³é€å¯’è¡£',p:['é›²é–‹æœˆå‡ºæ­£åˆ†æ˜','ä¸é ˆé€²é€€å•å‰ç¨‹','å©šå§»çš†ç”±å¤©è¨»å®š','å’Œåˆæ¸…å‰è¬äº‹æˆ'],j:{åŠŸå:'ç„¡æœ›',æœˆä»¤:'æ·¡æ·¡',å©šå§»:'ä¸å‰',è²¡åˆ©:'å¾®è–„',æ²»ç—…:'æ‹–å»¶',å°‹äºº:'é›£è¦‹',å®˜äº‹:'å’Œè§£',å®¶é‹:'å®ˆæˆ'},m:'é †å…¶è‡ªç„¶'},
            {id:4,t:'ä¹™å¯',l:'ä¸­å¹³',s:'å­«æ‚Ÿç©ºå¤§é›£ç«ç½',p:['ç¦¾ç¨»çœ‹çœ‹çµæˆå®Œ','æ­¤äº‹å¿…å®šå…©ç›¸å…¨','å›åˆ°å®¶ä¸­å¯¬å¿ƒå','å¦»å…’é¼“èˆæ¨‚åœ˜åœ“'],j:{åŠŸå:'å°‘',æœˆä»¤:'ä¸­å¹³',å©šå§»:'åˆ',è²¡åˆ©:'å¹³',æ²»ç—…:'å®‰',å°‹äºº:'è¦‹',å®˜äº‹:'æ‹–',å®¶é‹:'åœ˜åœ“'},m:'å…ˆè‹¦å¾Œç”˜'},
            {id:5,t:'ä¹™è¾°',l:'å¹³å‰',s:'é¾æ¶“å®³å­«è‡',p:['å„„è¬é‡‘éŠ€èˆ‡çˆ¾ç‰½','é ˆé˜²ç™½å¿ƒäººæ‰€é€£','å¯¬å¿ƒä¸”å®ˆå¯¬å¿ƒå','å¿…ç„¶é‡å¾—è²´äººé€£'],j:{åŠŸå:'é˜»',æœˆä»¤:'ä¸é‚',å©šå§»:'å¹³',è²¡åˆ©:'å®ˆ',æ²»ç—…:'é‹',å°‹äºº:'é›£',å®˜äº‹:'é˜²',å®¶é‹:'å®ˆèˆŠ'},m:'æé˜²å°äºº'},
            // ... (ç‚ºç¢ºä¿å–®æ©Ÿç‰ˆé‹è¡Œæµæš¢ï¼Œæ­¤è™•ä¿ç•™å‰5é¦–çœŸå¯¦ç¯„ä¾‹ï¼Œå…¶é¤˜ä½¿ç”¨ä¸‹æ–¹çš„ç”Ÿæˆå™¨ç”¢ç”Ÿï¼Œé‚è¼¯èˆ‡ V27 ç›¸åŒ)
        ];

        const fillLots = () => {
            const fullLots = [...LOTS_DATA];
            const existingIds = new Set(fullLots.map(l => l.id));
            const stems = ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
            const branches = ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
            const poemLines = [
                ['é•·æ±Ÿé¢¨æµªæ¼¸æ¼¸éœ', 'äºä»Šå¾—é€²å¯å®‰å¯§', 'æ¯”ä¸‹æœˆä¸‹è¨€äººå°‘', 'åªæå‰é€”å‘½æœ‰çª®'],
                ['å‹¸å›æŠŠå®šå¿ƒè«è™›', 'å¤©è¨»è¡£ç¥¿è‡ªæœ‰é¤˜', 'å’Œåˆé‡é‡å¸¸å‰æ…¶', 'æ™‚ä¾†çµ‚é‡å¾—æ˜ç '],
                ['é¢¨é›²è‡´é›¨è½æ´‹æ´‹', 'å¤©ç½æ™‚æ°£å¿…æœ‰å‚·', 'å‘½å…§æ­¤äº‹é›£å’Œåˆ', 'æ›´é€¢ä¸€è¶³å‡ºå¤–é„‰'],
                ['å‘½ä¸­æ­£é€¢ç¾…å­›é—œ', 'ç”¨ç›¡å¿ƒæ©Ÿç¸½æœªä¼‘', 'ä½œç¦å•ç¥é›£å¾—é', 'æ°æ˜¯è¡ŒèˆŸä¸Šé«˜ç˜'],
                ['ç¦¾ç¨»çœ‹çœ‹çµæˆå®Œ', 'æ­¤äº‹å¿…å®šå…©ç›¸å…¨', 'å›åˆ°å®¶ä¸­å¯¬å¿ƒå', 'å¦»å…’é¼“èˆæ¨‚åœ˜åœ“']
            ];

            for (let i = 1; i <= 60; i++) {
                if (!existingIds.has(i)) {
                    const stem = stems[(i-1) % 10];
                    const branch = branches[(i-1) % 12];
                    const title = `${stem}${branch}`;
                    const lucks = ['å¤§å‰', 'ä¸Šå‰', 'ä¸­å‰', 'ä¸­å¹³', 'ä¸‹ä¸‹'];
                    const luck = lucks[i % 5];
                    const pIndex = i % poemLines.length;
                    const j = luck === 'å¤§å‰' ? {åŠŸå:'é¡¯', æœˆä»¤:'åœ“', å©šå§»:'æˆ', è²¡åˆ©:'æœ‰', æ²»ç—…:'ç™’', å°‹äºº:'è¦‹', å®˜äº‹:'å‹', å®¶é‹:'éš†'} :
                              luck === 'ä¸‹ä¸‹' ? {åŠŸå:'ç„¡', æœˆä»¤:'è™§', å©šå§»:'é›£', è²¡åˆ©:'å¤±', æ²»ç—…:'éšª', å°‹äºº:'æ³', å®˜äº‹:'è™§', å®¶é‹:'è¡°'} :
                              {åŠŸå:'å¹³', æœˆä»¤:'å¹³', å©šå§»:'åˆ', è²¡åˆ©:'å¹³', æ²»ç—…:'å®‰', å°‹äºº:'é²', å®˜äº‹:'å’Œ', å®¶é‹:'å®‰'};

                    fullLots.push({
                        id: i, t: title, l: luck, s: `å¤äººå…¸æ•…${i}`, p: poemLines[pIndex], j: j, m: luck === 'å¤§å‰' ? 'è¬äº‹å¦‚æ„' : 'å®ˆæˆå¾…æ™‚'
                    });
                }
            }
            return fullLots.sort((a, b) => a.id - b.id);
        };

        const LOTS_60_FULL = fillLots();

        // --- æ ¸å¿ƒé‚è¼¯ (èˆ‡ V27 ç›¸åŒ) ---
        const analyzeIntent = (q) => {
            const safeQ = q || "";
            let category = "åŠŸå";
            let type = "work";

            if (safeQ.match(/å­¸æ¥­|è€ƒè©¦|è®€æ›¸|æˆç¸¾|æ¦œå–®|è½‰ç³»|ç§‘ç³»|ä¼‘å­¸|å¾©å­¸|å­¸æ ¡|å¤§å­¸|é«˜ä¸­|ç ”ç©¶æ‰€|è«–æ–‡|æ•™æˆ|é¸ä¿®|å¿…ä¿®/)) {
                category = "åŠŸå"; type = "study";
            } else if (safeQ.match(/å¦ä¸€[ä¼´åŠ]|å°è±¡|å§»ç·£|æ„›|æ¡ƒèŠ±|å¾©åˆ|åˆ†æ‰‹|çµå©š|æ›–æ˜§|ç”·å‹|å¥³å‹|è€å…¬|è€å©†|å¤«å¦»|å–œæ­¡/)) {
                category = "å©šå§»"; type = "love";
            } else if (safeQ.match(/éŒ¢|è²¡|æŠ•è³‡|è‚¡ç¥¨|ç”Ÿæ„|è²·æˆ¿|å‚µ/)) {
                category = "è²¡åˆ©"; type = "wealth";
            } else if (safeQ.match(/å¥åº·|ç—…|ç—›|èº«é«”|æ‰‹è¡“|ä½é™¢|é–‹åˆ€/)) {
                category = "æ²»ç—…"; type = "health";
            } else if (safeQ.match(/å·¥ä½œ|æ±‚è·|äº‹æ¥­|é¢è©¦|å…¬å¸|è€é—†|è–ªæ°´|å‡é·|å±¥æ­·|offer|è½‰è·|é›¢è·/)) {
                category = "åŠŸå"; type = "work";
            } else if (safeQ.match(/å°‹äºº|æ‰¾|å¤±ç‰©|ä¸è¦‹/)) { category = "å°‹äºº"; type = "missing"; 
            } else if (safeQ.match(/å®˜å¸|æ³•å¾‹|è¨´è¨Ÿ|å‘Š/)) { category = "å®˜äº‹"; type = "legal"; 
            } else if (safeQ.match(/å®¶|æ¬å®¶|é‹å‹¢|å¹³å®‰/)) { category = "å®¶é‹"; type = "family"; }

            const nouns = safeQ.match(/(é›»å­æ›¸ä¼åŠƒ|å·¥ç¨‹å¸«|æ¥­å‹™|å°è±¡|å¦ä¸€[ä¼´åŠ]|ç”·æœ‹å‹|å¥³æœ‹å‹|è€å…¬|è€å©†|æˆ¿å­|æ‰‹è¡“|è€ƒè©¦|è½‰ç³»|ç§‘ç³»|è«–æ–‡)/);
            let defaultSubject = 'é€™ä»¶äº‹';
            if (type === 'study') defaultSubject = 'å­¸æ¥­å‰ç¨‹';
            else if (type === 'work') defaultSubject = 'å·¥ä½œç™¼å±•';
            else if (type === 'love') defaultSubject = 'æ„Ÿæƒ…ç·£åˆ†';
            else if (type === 'health') defaultSubject = 'èº«é«”å¥åº·';

            const subject = nouns ? nouns[0] : defaultSubject;
            return { category, type, subject };
        };

        const generateDeepPersonalizedGuidance = (userName, question, lot) => {
            // é˜²å‘†æª¢æŸ¥
            if (!lot || !lot.p || !lot.j) return "ç¥è«­è§£æä¸­ï¼Œè«‹ç¨å€™...";

            const { category, type, subject } = analyzeIntent(question);
            const judgement = lot.j[category] || "å¹³å¹³";
            
            const opening = `ä¿¡çœ¾ ${userName} æ‚¨å¥½ï¼Œåª½ç¥–å©†å·²ç¶“è½è¦‹äº†æ‚¨çš„å¿ƒè²ã€‚`;
            let section1 = `\nã€æ‚¨çš„ç¥ˆæ±‚ã€‘\nã€Œ${question}ã€\n`;
            let section2 = `\nã€åª½ç¥–æŒ‡å¼•æ–¹å‘ã€‘\né‡å°æ­¤å•é¡Œï¼Œåª½ç¥–å©†æŒ‡ç¤ºæ‡‰å¾ã€Œ${category}ã€çš„è§’åº¦ä¾†è§£æã€‚\næœ¬ç±¤åœ¨ã€Œ${category}ã€æ–¹é¢çš„è–æ„é¡¯ç¤ºç‚ºï¼šã€Œ${judgement}ã€ã€‚\n`;

            let analysis = `\nã€ç±¤è©©é€å¥è©³è§£ã€‘\n`;
            
            // å®‰å…¨è®€å–è©©å¥
            const p0 = lot.p[0] || "";
            const p1 = lot.p[1] || "";
            const p2 = lot.p[2] || "";
            const p3 = lot.p[3] || "";

            if (type === 'health') {
                analysis += `1. ã€Œ${p0}ã€\n`;
                if (judgement.match(/ç™’|å®‰|å‰/)) analysis += `é€™å¥ç±¤è©©æ˜¯å¥½é å…†ï¼è±¡å¾µèº«é«”çš„é™°éœ¾å³å°‡æ•£å»ï¼Œç—…æƒ…æœƒé€æ¼¸ç©©å®šã€‚\n\n`;
                else analysis += `é€™å¥è©©æš—ç¤ºç›®å‰ç‹€æ³è¼ƒç‚ºåè¦†ï¼Œç—…æ ¹æœªé™¤ï¼Œå¯èƒ½éœ€è¦è¼ƒé•·æ™‚é–“çš„èª¿é¤Šã€‚\n\n`;
            } else if (type === 'work') {
                analysis += `1. ã€Œ${p0}ã€\n`;
                if (judgement.match(/é¡¯|æœ‰|æˆ|é€š/)) analysis += `è·å ´ä¸Šçš„çƒé›²å³å°‡æ•£å»ï¼é€™ä»£è¡¨éå»çš„é˜»ç¤™å°‡æœƒé é›¢ï¼Œæ‚¨çš„æ‰è¯å³å°‡è¢«çœ‹è¦‹ã€‚\n\n`;
                else analysis += `é€™å¥è©©æé†’æ‚¨ï¼Œç›®å‰å¤§ç’°å¢ƒæˆ–å…¬å¸å…§éƒ¨å±€å‹¢ä¸æ˜æœ—ï¼Œç¾åœ¨ä¸æ˜¯å¼·å‡ºé ­çš„æ™‚å€™ã€‚\n\n`;
            } else {
                analysis += `1. ã€Œ${p0}ã€\n`;
                if (lot.l.includes('å‰')) analysis += `é€™å¥ç±¤è©©è±¡å¾µé‹å‹¢å¥½è½‰ï¼Œæ‚¨æ‰€æ±‚ä¹‹äº‹å°‡æœƒæœ‰å¥½çš„é–‹å§‹ã€‚\n\n`;
                else analysis += `é€™å¥ç±¤è©©åæ˜ äº†ç›®å‰è™•å¢ƒè¼ƒç‚ºè‰±é›£ï¼Œéœ€è¦å¤šä¸€é»è€å¿ƒç­‰å¾…è½‰æ©Ÿã€‚\n\n`;
            }

            analysis += `2. ã€Œ${p1}ã€\né€™å¥è©©æ˜¯åœ¨å‘Šè¨´æ‚¨ï¼Œéç¨‹ä¸­çš„å¿ƒæ…‹éå¸¸é‡è¦ã€‚ä¿æŒå…‰æ˜ç£Šè½ï¼Œè‡ªç„¶èƒ½é¿é–‹ç½ç¦ã€‚\n\n`;
            analysis += `3. ã€Œ${p2}ã€\n${lot.l.includes('å‰') ? 'é€™æ˜¯ä¸€å€‹è½‰æŠ˜é»ï¼åª½ç¥–å©†é¼“å‹µæ‚¨æ–¹å‘æ˜¯æ­£ç¢ºçš„ï¼Œç¹¼çºŒå‰è¡Œå§ã€‚' : 'é€™è£¡åª½ç¥–å©†çµ¦äº†æ‚¨ä¸€å€‹æé†’ï¼Œå‰æ–¹çš„è·¯å¯èƒ½é‚„æœ‰é˜»ç¤™ï¼Œå»ºè­°å…ˆåœçœ‹è½ã€‚'}\n\n`;
            analysis += `4. ã€Œ${p3}ã€\næœ€çµ‚çµæœï¼Œåªè¦å¿ƒå­˜å–„å¿µï¼Œåª½ç¥–å©†æœƒä¿ä½‘æ‚¨å¹³å®‰é †é‚ï¼Œè¬äº‹æ¸…å‰ã€‚\n`;

            let summary = `\nã€ç¸½çµã€‘\né—œæ–¼${subject}ï¼Œ`;
            if (type === 'health') summary += judgement.match(/ç™’|å®‰/) ? `åª½ç¥–æŒ‡ç¤ºï¼šå¯¬å¿ƒé¤Šç—…ï¼Œä¸å¿…éåº¦æ“”æ†‚ã€‚` : `åª½ç¥–æŒ‡ç¤ºï¼šåˆ‡å‹¿æ‹–å»¶ï¼Œç©æ¥µæ²»ç™‚ã€‚`;
            else if (type === 'work') summary += judgement.match(/é¡¯|æœ‰/) ? `åª½ç¥–æŒ‡ç¤ºï¼šæ™‚é‹äº¨é€šï¼ŒæŠŠæ¡è‰¯æ©Ÿã€‚` : `åª½ç¥–æŒ‡ç¤ºï¼šæ™‚æ©Ÿæœªåˆ°ï¼Œæ²ˆæ½›å‹¿èºã€‚`;
            else summary += `åª½ç¥–å»ºè­°æ‚¨ï¼š${lot.l.includes('å‰') ? 'æŠŠæ¡è‰¯æ©Ÿï¼Œå‹‡å¾€ç›´å‰ã€‚' : 'éœå¾…æ™‚æ©Ÿï¼Œå‹¿æ“ä¹‹éæ€¥ã€‚'}\n`;
            
            return opening + section1 + section2 + analysis + summary;
        };

        // --- ä¸»å…ƒä»¶ ---
        const BEI_TYPES = { SHENG: 'è–ç­Š', XIAO: 'ç¬‘ç­Š', YIN: 'é™°ç­Š' };
        const STEPS = { INTRO: 0, INPUT: 1, ASK_PERMISSION: 2, SHAKING: 3, PICK_LOT: 4, CONFIRM_LOT: 5, AI_ANALYZING: 6, RESULT: 7 };

        // æ“²ç­Šå…ƒä»¶
        const MoonBlock = ({ type, rotateClass }) => (
            <div className={`w-24 h-12 relative transition-transform duration-700 ease-out transform-style-3d ${rotateClass}`}>
                <div className={`absolute inset-0 backface-hidden ${type === 1 ? 'z-10' : 'z-0'}`} style={{ transform: type === 1 ? 'rotateX(0deg)' : 'rotateX(180deg)' }}>
                    <svg viewBox="0 0 100 50" className="drop-shadow-lg"><path d="M10,50 Q50,-20 90,50 Z" fill="#b91c1c" stroke="#7f1d1d" strokeWidth="2" /><path d="M20,45 Q50,0 80,45" fill="none" stroke="#991b1b" strokeWidth="1" opacity="0.5" /></svg>
                </div>
                <div className={`absolute inset-0 backface-hidden ${type === 0 ? 'z-10' : 'z-0'}`} style={{ transform: type === 0 ? 'rotateX(0deg)' : 'rotateX(-180deg)' }}>
                    <svg viewBox="0 0 100 50" className="drop-shadow-lg"><path d="M10,50 Q50,-20 90,50 Z" fill="#fca5a5" stroke="#b91c1c" strokeWidth="2" /><path d="M15,48 Q50,-10 85,48 Z" fill="#fee2e2" opacity="0.8" /><text x="50" y="40" fontSize="8" textAnchor="middle" fill="#b91c1c" opacity="0.3">å¤©åå®®</text></svg>
                </div>
            </div>
        );

        function MazuTempleV27() {
            const [step, setStep] = useState(STEPS.INTRO);
            const [userName, setUserName] = useState('');
            const [question, setQuestion] = useState('');
            const [isTossing, setIsTossing] = useState(false);
            const [isResetting, setIsResetting] = useState(false);
            const [beiResult, setBeiResult] = useState('');
            const [leftBeiType, setLeftBeiType] = useState(0); 
            const [rightBeiType, setRightBeiType] = useState(1);
            const [tossCount, setTossCount] = useState(0); 
            const [shakeCount, setShakeCount] = useState(0);
            const [isShakingAnim, setIsShakingAnim] = useState(false); 
            const [tempLot, setTempLot] = useState(null);
            const [message, setMessage] = useState('');
            const [guidanceText, setGuidanceText] = useState('');
            const [aiText, setAiText] = useState(''); // Added missing state
            const [generatedImg, setGeneratedImg] = useState(null);
            const [showImgModal, setShowImgModal] = useState(false);
            const canvasRef = useRef(null);

            // æ“²ç­Š
            const performToss = (onResult) => {
                if (isTossing || isResetting) return;
                setIsTossing(true); setBeiResult(''); setMessage('èª å¿ƒæ“²å‡º...'); setTossCount(c => c + 1); 
                setTimeout(() => {
                    const rand = Math.random();
                    let result;
                    if (step === STEPS.ASK_PERMISSION) result = rand < 0.7 ? BEI_TYPES.SHENG : (rand < 0.85 ? BEI_TYPES.XIAO : BEI_TYPES.YIN);
                    else result = rand < 0.55 ? BEI_TYPES.SHENG : (rand < 0.75 ? BEI_TYPES.XIAO : BEI_TYPES.YIN);
                    
                    setBeiResult(result); setIsTossing(false);
                    if (result === BEI_TYPES.SHENG) { setLeftBeiType(0); setRightBeiType(1); }
                    else if (result === BEI_TYPES.XIAO) { setLeftBeiType(0); setRightBeiType(0); }
                    else { setLeftBeiType(1); setRightBeiType(1); }
                    if (onResult) onResult(result);
                }, 1500);
            };

            const onAskPermission = () => {
                performToss((result) => {
                    if (result === BEI_TYPES.SHENG) {
                        setMessage('è–ç­Šï¼åª½ç¥–ç­”æ‡‰è³œç±¤ï¼Œè«‹é–‹å§‹æ–ç±¤ç­’ã€‚');
                        setIsResetting(true); setTimeout(() => { setStep(STEPS.SHAKING); setIsResetting(false); }, 2000);
                    } else {
                        setMessage(`æ“²å‡º${result}ã€‚åª½ç¥–ç¬‘è€Œä¸èªæˆ–ä¸å…ï¼Œè«‹èª å¿ƒå†è©¦ä¸€æ¬¡ã€‚`);
                    }
                });
            };

            const onShake = () => {
                if (step !== STEPS.SHAKING || isShakingAnim) return;
                setIsShakingAnim(true); setShakeCount(c => c + 1); if (navigator.vibrate) navigator.vibrate([30]);
                setTimeout(() => {
                    setIsShakingAnim(false);
                    if (shakeCount >= 5 || (shakeCount > 3 && Math.random() > 0.6)) {
                        const picked = LOTS_60_FULL[Math.floor(Math.random() * LOTS_60_FULL.length)];
                        setTempLot(picked); setStep(STEPS.PICK_LOT); setMessage('æœ‰ä¸€æ”¯ç±¤æµ®å‡ºä¾†äº†ï¼è«‹é»æ“Šå®ƒæŠ½å‡ºã€‚'); setShakeCount(0); 
                    } else { setMessage(`å†ç”¨åŠ›æ–ä¸€ä¸‹...`); }
                }, 500);
            };

            const onPickLot = () => { setMessage(`æŠ½å‡ºã€${tempLot.t}ã€‘ç±¤ã€‚è«‹æ“²ç­Šç¢ºèªæ˜¯å¦ç‚ºæ­¤ç±¤ã€‚`); setStep(STEPS.CONFIRM_LOT); };

            const onConfirmLot = () => {
                performToss((result) => {
                    if (result === BEI_TYPES.SHENG) {
                        setMessage('è–ç­Šï¼åª½ç¥–ç¢ºèªæ˜¯é€™æ”¯ç±¤ã€‚');
                        setIsResetting(true); setTimeout(() => { startAiAnalysis(); }, 1500);
                    } else {
                        setMessage(`æ“²å‡º${result}ã€‚åª½ç¥–èªªä¸æ˜¯é€™æ”¯ç±¤ï¼Œè«‹é‡æ–°æ–ç±¤ã€‚`);
                        setIsResetting(true); setTimeout(() => { setTempLot(null); setStep(STEPS.SHAKING); setShakeCount(0); setIsResetting(false); }, 2500);
                    }
                });
            };

            const startAiAnalysis = () => {
                if (!tempLot) { setStep(STEPS.INTRO); setIsResetting(false); return; }
                
                // Set loading state and text immediately to avoid empty render
                setStep(STEPS.AI_ANALYZING); 
                setIsResetting(false); 
                setMessage('ç¥è«­è§£æä¸­...');
                
                // Simulate progressive loading text
                const loadingTexts = ["é€£çµç±¤è©©æ™ºæ…§åº«...", "åˆ†ææ‚¨çš„ç…©æƒ±...", "æ¨æ¼”äº”è¡Œå¦è±¡...", "ç”Ÿæˆæº«æš–æŒ‡å¼•..."];
                let i = 0;
                setAiText(loadingTexts[0]);
                
                const interval = setInterval(() => {
                    i++;
                    if (i < loadingTexts.length) {
                        setAiText(loadingTexts[i]);
                    } else {
                        clearInterval(interval);
                        // Generate text inside try-catch to prevent crash
                        try {
                            const text = generateDeepPersonalizedGuidance(userName, question, tempLot);
                            setGuidanceText(text);
                            setStep(STEPS.RESULT);
                        } catch (err) {
                            console.error("Analysis Error:", err);
                            setMessage("è§£æç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦");
                            setStep(STEPS.SHAKING);
                        }
                    }
                }, 600);
            };

            const reset = () => {
                setStep(STEPS.INTRO); setUserName(''); setQuestion(''); setTempLot(null);
                setMessage(''); setBeiResult(''); setShakeCount(0); setGuidanceText(''); setGeneratedImg(null); setIsResetting(false);
            };

            // --- Canvas ç¹ªåœ– ---
            const generateImage = () => {
                const canvas = canvasRef.current;
                if (!canvas || !tempLot) return;
                const ctx = canvas.getContext('2d');
                const width = 1000;
                
                const ctxDummy = document.createElement('canvas').getContext('2d');
                ctxDummy.font = '28px "Noto Serif TC", serif';
                const padding = 50;
                const contentWidth = width - (padding * 2);
                
                const paragraphs = guidanceText.split('\n');
                let textHeight = 0;
                paragraphs.forEach(p => {
                    let line = '';
                    for(let w of p.split('')) {
                        if(ctxDummy.measureText(line + w).width > contentWidth) {
                            textHeight += 40; line = w;
                        } else { line += w; }
                    }
                    textHeight += 40; textHeight += 20; 
                });

                const slipHeight = 550;
                const totalHeight = 180 + slipHeight + 50 + 100 + textHeight + 100; 

                canvas.width = width;
                canvas.height = totalHeight;

                // èƒŒæ™¯
                ctx.fillStyle = '#fffcf5'; ctx.fillRect(0, 0, width, totalHeight);
                for(let i=0; i<30000; i++) {
                    ctx.fillStyle = `rgba(220, 200, 180, ${Math.random() * 0.3})`;
                    ctx.fillRect(Math.random() * width, Math.random() * totalHeight, 2, 2);
                }

                ctx.strokeStyle = '#b91c1c'; ctx.lineWidth = 20; ctx.strokeRect(0, 0, width, totalHeight);
                ctx.strokeStyle = '#d97706'; ctx.lineWidth = 4; ctx.strokeRect(25, 25, width - 50, totalHeight - 50);

                ctx.fillStyle = '#b91c1c'; ctx.textAlign = 'center';
                ctx.font = 'bold 56px "Noto Serif TC", serif'; ctx.fillText('å¤©åå®®éˆç±¤', width / 2, 100);

                const slipTopY = 160;
                ctx.fillStyle = '#fff0f0'; ctx.fillRect(padding, slipTopY, width - padding*2, slipHeight);
                ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 4; ctx.strokeRect(padding, slipTopY, width - padding*2, slipHeight);

                ctx.fillStyle = '#991b1b'; ctx.font = 'bold 36px "Noto Serif TC", serif';
                ctx.fillText(`${tempLot.t}ç±¤ â€§ ${tempLot.l}`, width / 2, slipTopY + 60);
                ctx.font = '24px "Noto Serif TC", serif'; ctx.fillStyle = '#b91c1c';
                ctx.fillText(`ç¬¬${tempLot.id}ç±¤`, width/2, slipTopY + 30);

                ctx.fillStyle = '#4b5563'; ctx.font = '28px "Noto Serif TC", serif';
                ctx.fillText(`ã€${tempLot.s}ã€‘`, width / 2, slipTopY + 100);

                ctx.fillStyle = '#111827'; ctx.font = 'bold 44px "Noto Serif TC", serif';
                const poemXStart = width / 2 + 150;
                const poemYStart = slipTopY + 160;
                tempLot.p.forEach((line, i) => {
                    const x = poemXStart - (i * 100);
                    for(let j=0; j<line.length; j++) {
                        ctx.fillText(line[j], x, poemYStart + (j * 60));
                    }
                });

                ctx.font = '24px "Noto Serif TC", serif'; ctx.textAlign = 'left';
                const j = tempLot.j;
                const drawJ = (k, v, x, y) => {
                    ctx.fillStyle = '#7f1d1d'; ctx.fillText(k, x, y);
                    ctx.fillStyle = '#dc2626'; ctx.fillText(v, x + 60, y);
                };
                let jy = slipTopY + 180;
                drawJ('åŠŸå', j.åŠŸå, padding + 20, jy); drawJ('æœˆä»¤', j.æœˆä»¤, padding + 20, jy + 80); 
                drawJ('å©šå§»', j.å©šå§», padding + 20, jy + 160); drawJ('å®¶é‹', j.å®¶é‹, padding + 20, jy + 240);

                jy = slipTopY + 180;
                drawJ('è²¡åˆ©', width - padding - 160, jy); drawJ('æ²»ç—…', width - padding - 160, jy + 80);
                drawJ('å°‹äºº', width - padding - 160, jy + 160); drawJ('å®˜äº‹', width - padding - 160, jy + 240);

                const dividerY = slipTopY + slipHeight + 40;
                ctx.beginPath(); ctx.moveTo(padding, dividerY); ctx.lineTo(width - padding, dividerY);
                ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();

                let cursorY = dividerY + 60;
                ctx.textAlign = 'left';
                ctx.fillStyle = '#b91c1c'; ctx.font = 'bold 32px "Noto Serif TC", serif';
                ctx.fillText('ã€åª½ç¥–çš„æº«æš–æŒ‡å¼•ã€‘', padding, cursorY);
                cursorY += 50;

                ctx.fillStyle = '#374151'; ctx.font = '28px "Noto Serif TC", serif';
                paragraphs.forEach(p => {
                    let line = '';
                    for(let w of p.split('')) {
                        if(ctx.measureText(line + w).width > contentWidth) {
                            ctx.fillText(line, padding, cursorY);
                            line = w; cursorY += 40;
                        } else { line += w; }
                    }
                    ctx.fillText(line, padding, cursorY);
                    cursorY += 60; 
                });

                ctx.textAlign = 'center'; ctx.fillStyle = '#9ca3af'; ctx.font = '20px "Noto Serif TC", serif';
                ctx.fillText('ç·šä¸Šåª½ç¥–éˆç±¤ â€§ èª å¿ƒçµç·£', width / 2, totalHeight - 30);

                try {
                    const url = canvas.toDataURL('image/jpeg', 0.9);
                    setGeneratedImg(url); setShowImgModal(true);
                } catch(e) { console.error(e); }
            };

            // --- Render ---
            return (
                <div className="flex flex-col items-center justify-center min-h-screen py-6 px-4">
                    <style>{`
                        .writing-vertical { writing-mode: vertical-rl; }
                        :root { --rotate-end-left: ${leftBeiType===1?'0deg':'-180deg'}; --rotate-end-right: ${rightBeiType===1?'0deg':'-180deg'}; }
                    `}</style>
                    <canvas ref={canvasRef} className="hidden" />

                    {showImgModal && generatedImg && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" onClick={() => setShowImgModal(false)}>
                            <div className="bg-white rounded-lg p-4 max-w-sm w-full relative shadow-2xl animate-fade-in" onClick={e => e.stopPropagation()}>
                                <button onClick={() => setShowImgModal(false)} className="absolute -top-3 -right-3 bg-red-600 text-white rounded-full p-1 shadow-lg z-10"><X size={20}/></button>
                                <h3 className="text-red-800 font-bold text-center mb-2 flex items-center justify-center gap-2"><Download size={18}/> çµç·£åœ–å·²ç”Ÿæˆ</h3>
                                <div className="border-4 border-yellow-500 rounded overflow-hidden mb-3 max-h-[70vh] overflow-y-auto bg-gray-100">
                                    <img src={generatedImg} alt="ç±¤è©©çµç·£åœ–" className="w-full h-auto" />
                                </div>
                                <p className="text-gray-600 text-sm text-center font-bold bg-yellow-100 p-2 rounded">ğŸ‘† è«‹é•·æŒ‰ä¸Šæ–¹åœ–ç‰‡å„²å­˜ ğŸ‘†</p>
                            </div>
                        </div>
                    )}

                    <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/wood-pattern.png')] opacity-100 pointer-events-none"></div>
                    
                    <header className="z-10 text-center mb-6 relative">
                        <div className="bg-red-800/90 border-2 border-yellow-500/50 px-8 py-3 rounded-full shadow-lg backdrop-blur-sm">
                            <h1 className="text-2xl md:text-3xl font-bold text-yellow-400 tracking-widest flex items-center gap-3"><Star className="text-yellow-400"/> å¤©åå®®ç·šä¸Šéˆç±¤ <Star className="text-yellow-400"/></h1>
                        </div>
                    </header>

                    <div className="z-20 min-h-[60px] flex items-center justify-center w-full max-w-md mb-4 px-4">
                        {message && <div className="bg-black/60 border-l-4 border-yellow-500 text-yellow-100 px-6 py-3 rounded-r-lg shadow-lg animate-fade-in">{message}</div>}
                    </div>

                    <main className="z-10 w-full max-w-md flex-1 flex flex-col items-center justify-center relative">
                        {step === STEPS.INTRO && (
                            <div className="bg-red-900/40 backdrop-blur-md p-8 rounded-2xl border border-yellow-500/30 text-center shadow-2xl space-y-8 animate-fade-in">
                                <div className="w-24 h-24 bg-yellow-500 rounded-full mx-auto flex items-center justify-center shadow-lg ring-4 ring-yellow-600/50"><User size={48} className="text-red-900"/></div>
                                <div>
                                    <h2 className="text-2xl font-bold text-yellow-200 mb-2">èª å¿ƒæ±‚ç±¤</h2>
                                    <div className="bg-black/30 p-6 rounded-lg text-sm text-gray-200 border border-white/10 text-left">
                                        <p className="flex items-center gap-2 text-yellow-400 mb-4 font-bold text-lg border-b border-yellow-500/50 pb-2"><ListOrdered size={20}/> è™”èª æ±‚ç±¤å››æ­¥é©Ÿ</p>
                                        <div className="space-y-3">
                                            <div className="flex gap-3"><span className="bg-yellow-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">1</span><p>è¼¸å…¥å§“åèˆ‡ç¥ˆæ±‚äº‹é …ï¼Œèª å¿ƒé»˜å¿µã€‚</p></div>
                                            <div className="flex gap-3"><span className="bg-yellow-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">2</span><p>æ“²ç­Šè«‹ç¤ºåª½ç¥–æ˜¯å¦é¡˜æ„è³œç±¤ã€‚</p></div>
                                            <div className="flex gap-3"><span className="bg-yellow-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">3</span><p>æ–å‹•ç±¤ç­’ç›´è‡³è–ç±¤æµ®å‡ºã€‚</p></div>
                                            <div className="flex gap-3"><span className="bg-yellow-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">4</span><p>å†æ¬¡æ“²ç­Šç¢ºèªï¼Œé ˜å–ç±¤è©©èˆ‡è§£è®€ã€‚</p></div>
                                        </div>
                                    </div>
                                </div>
                                <button onClick={() => setStep(STEPS.INPUT)} className="w-full py-3 bg-gradient-to-r from-yellow-600 to-yellow-500 text-red-950 font-bold rounded-lg shadow-lg hover:scale-105 transition-transform">é–‹å§‹åƒæ‹œ</button>
                            </div>
                        )}

                        {step === STEPS.INPUT && (
                            <div className="w-full bg-red-900/60 backdrop-blur p-6 rounded-xl border border-yellow-600/30 shadow-2xl space-y-6 animate-fade-in">
                                <h3 className="text-lg font-bold text-yellow-300 text-center border-b border-yellow-600/30 pb-3">ç¨Ÿå ±è³‡æ–™</h3>
                                <div className="space-y-4">
                                    <div><label className="block text-xs text-yellow-200 mb-1 ml-1">å§“å</label><input type="text" value={userName} onChange={e => setUserName(e.target.value)} className="w-full bg-black/30 border border-yellow-700/50 rounded p-3 text-yellow-50 focus:outline-none focus:border-yellow-500 text-white" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å"/></div>
                                    <div><label className="block text-xs text-yellow-200 mb-1 ml-1">ç¥ˆæ±‚äº‹é … (è«‹è©³è¿°)</label><textarea value={question} onChange={e => setQuestion(e.target.value)} className="w-full h-40 bg-black/30 border border-yellow-700/50 rounded p-3 text-yellow-50 focus:outline-none focus:border-yellow-500 resize-none text-white" placeholder="ä¾‹ï¼šæƒ³è½‰ç³»åˆ°è¨­è¨ˆç³»ï¼Œä¸çŸ¥é“æ˜¯å¦é©åˆï¼Ÿ"/></div>
                                </div>
                                <button onClick={() => { if(!userName || !question) { setMessage("è«‹å¡«å¯«å®Œæ•´ä»¥ç¤ºèª å¿ƒ"); return; } setStep(STEPS.ASK_PERMISSION); setMessage("è«‹é»˜å¿µå•é¡Œï¼Œæ¥è‘—æ“²ç­Šè«‹ç¤ºæ˜¯å¦è³œç±¤ã€‚"); }} className="w-full py-3 bg-yellow-600 hover:bg-yellow-500 text-red-950 font-bold rounded-lg shadow-lg">è³‡æ–™ç¨Ÿå ±å®Œç•¢</button>
                            </div>
                        )}

                        {(step === STEPS.ASK_PERMISSION || step === STEPS.CONFIRM_LOT) && (
                            <div className="flex flex-col items-center justify-center w-full h-full pb-10">
                                <div className="relative w-full h-64 flex items-center justify-center gap-12 perspective-1000">
                                    <MoonBlock key={`l-${tossCount}`} type={isTossing?1:leftBeiType} rotateClass={isTossing?'animate-toss-left':''} side="left" />
                                    <MoonBlock key={`r-${tossCount}`} type={isTossing?1:rightBeiType} rotateClass={isTossing?'animate-toss-right':''} side="right" />
                                </div>
                                <div className="h-12 flex items-center justify-center mb-6">{beiResult && !isTossing && <span className="text-3xl font-bold text-yellow-400 animate-bounce">{beiResult}</span>}</div>
                                <button disabled={isTossing || isResetting} onClick={step===STEPS.ASK_PERMISSION ? onAskPermission : onConfirmLot} className={`px-12 py-4 rounded-full font-bold text-xl shadow-lg border-2 transition-all flex items-center gap-2 ${isTossing || isResetting ? 'bg-gray-600 border-gray-500 text-gray-400 cursor-not-allowed' : 'bg-red-600 border-red-400 text-white hover:bg-red-500'}`}>
                                    {(isTossing || isResetting) && <Lock size={18}/>}
                                    {step===STEPS.CONFIRM_LOT?'æ“²ç­Šç¢ºèª':'æ“²ç­Šè«‹ç¤º'}
                                </button>
                            </div>
                        )}

                        {(step === STEPS.SHAKING || step === STEPS.PICK_LOT) && (
                            <div className="flex flex-col items-center justify-end h-full pb-12 w-full" onClick={step===STEPS.SHAKING?onShake:undefined}>
                                <div className={`relative w-40 h-64 cursor-pointer select-none ${isShakingAnim ? 'animate-shake-hard' : ''}`}>
                                    <div className="absolute -top-10 left-1/2 transform -translate-x-1/2 w-32 h-64 flex justify-center items-end overflow-hidden z-0">
                                        {[...Array(8)].map((_, i) => (
                                            <div key={i} className="w-3 bg-yellow-200 border border-yellow-700/30 mx-[2px] rounded-t-sm origin-bottom" style={{
                                                height: '100%', 
                                                transform: `translateY(${isShakingAnim ? Math.random() * 20 : 0}px) rotate(${(i-4)*4}deg)`,
                                                transition: 'transform 0.1s'
                                            }}></div>
                                        ))}
                                    </div>
                                    
                                    {step === STEPS.PICK_LOT && (
                                        <div onClick={(e)=>{e.stopPropagation();onPickLot()}} className="absolute -top-32 left-1/2 -translate-x-1/2 w-8 h-64 bg-yellow-100 border-2 border-red-800 rounded-t-md cursor-pointer animate-bounce flex items-center justify-center writing-vertical font-bold text-red-900 z-20 shadow-xl">
                                            ç¬¬{tempLot?.id}ç±¤
                                            <div className="absolute -top-10 animate-pulse text-yellow-300 drop-shadow-md"><Hand size={32} className="rotate-180" /></div>
                                        </div>
                                    )}

                                    <div className="absolute bottom-0 w-full h-48 bg-gradient-to-r from-amber-800 via-amber-700 to-amber-900 rounded-b-3xl rounded-t-lg border-4 border-amber-950 shadow-2xl flex items-center justify-center z-10">
                                        <div className="w-24 h-24 border-4 border-amber-900/30 rounded-full flex items-center justify-center opacity-50"><span className="text-4xl font-serif font-bold text-black/40">ç±¤</span></div>
                                    </div>
                                </div>
                                <div className="mt-12 text-center h-20">
                                    {step === STEPS.SHAKING ? (
                                        <><p className="text-yellow-200 text-lg font-bold animate-pulse mb-2">è«‹é€£çºŒé»æ“Šç±¤ç­’ ({shakeCount})</p><div className="flex justify-center text-gray-500"><Move size={24} className="animate-wiggle" /></div></>
                                    ) : (<p className="text-yellow-200 text-xl font-bold animate-bounce">è«‹é»æ“Šä¸Šæ–¹æµ®å‡ºçš„ç±¤æ”¯ï¼</p>)}
                                </div>
                            </div>
                        )}

                        {step === STEPS.AI_ANALYZING && (
                            <div className="flex flex-col items-center justify-center h-full animate-fade-in text-center space-y-6">
                                <div className="relative">
                                    <div className="w-24 h-24 rounded-full border-4 border-yellow-500/30 animate-ping absolute inset-0"></div>
                                    <div className="w-24 h-24 rounded-full bg-yellow-500/20 backdrop-blur flex items-center justify-center animate-pulse-glow">
                                        <Heart size={48} className="text-yellow-300 fill-yellow-300" />
                                    </div>
                                </div>
                                <h3 className="text-2xl font-bold text-yellow-200">{aiText}</h3>
                            </div>
                        )}

                        {step === STEPS.RESULT && tempLot && guidanceText && (
                            <div className="w-full h-full flex flex-col animate-fade-in pb-8">
                                <div className="bg-[#fffbf0] text-red-900 rounded-lg p-4 shadow-2xl border-y-8 border-red-800 flex-1 flex flex-col overflow-hidden">
                                    <div className="border-4 border-red-800 p-2 mb-2 bg-red-50">
                                        <div className="text-center border-b-2 border-red-200 pb-2 mb-2">
                                            <div className="flex justify-between items-center px-2">
                                                <span className="font-bold text-lg">{tempLot.t}ç±¤</span>
                                                <span className="text-sm bg-red-800 text-white px-2 py-1 rounded">{tempLot.l}</span>
                                            </div>
                                            <p className="text-red-800 font-bold mt-1 text-sm">ç¬¬ {tempLot.id} ç±¤</p>
                                            <p className="text-gray-600 font-serif mt-1 text-sm">ã€{tempLot.s}ã€‘</p>
                                        </div>
                                        <div className="flex">
                                            <div className="w-1/6 text-xs text-red-900 flex flex-col gap-2 items-center border-r border-red-200 pt-2">
                                                <div><span className="block font-bold">åŠŸ</span><span className="text-red-600">{tempLot.j.åŠŸå}</span></div>
                                                <div><span className="block font-bold">æœˆ</span><span className="text-red-600">{tempLot.j.æœˆä»¤}</span></div>
                                                <div><span className="block font-bold">å©š</span><span className="text-red-600">{tempLot.j.å©šå§»}</span></div>
                                                <div><span className="block font-bold">å®¶</span><span className="text-red-600">{tempLot.j.å®¶é‹}</span></div>
                                            </div>
                                            <div className="flex-1 flex justify-center items-center py-2">
                                                <div className="flex flex-row-reverse gap-2">
                                                    {tempLot.p.map((line, idx) => (<div key={idx} className="writing-vertical text-lg font-serif font-bold text-black h-36 border-l border-red-100 pl-1">{line}</div>))}
                                                </div>
                                            </div>
                                            <div className="w-1/6 text-xs text-red-900 flex flex-col gap-2 items-center border-l border-red-200 pt-2">
                                                <div><span className="block font-bold">è²¡</span><span className="text-red-600">{tempLot.j.è²¡åˆ©}</span></div>
                                                <div><span className="block font-bold">ç—…</span><span className="text-red-600">{tempLot.j.æ²»ç—…}</span></div>
                                                <div><span className="block font-bold">å°‹</span><span className="text-red-600">{tempLot.j.å°‹äºº}</span></div>
                                                <div><span className="block font-bold">å®˜</span><span className="text-red-600">{tempLot.j.å®˜äº‹}</span></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-white/60 p-3 rounded border border-red-100 text-sm overflow-y-auto flex-1 whitespace-pre-line leading-relaxed text-justify text-gray-900">
                                        {guidanceText}
                                    </div>
                                </div>
                                <div className="mt-4 flex gap-4 justify-center">
                                    <button onClick={generateImage} className="px-6 py-3 bg-yellow-600 hover:bg-yellow-500 text-white rounded-full font-bold shadow-lg flex items-center gap-2"><Download size={18}/> ä¿å­˜çµç·£åœ–</button>
                                    <button onClick={reset} className="px-6 py-3 bg-red-800 hover:bg-red-700 text-yellow-100 rounded-full shadow-lg"><RotateCcw size={18}/></button>
                                </div>
                            </div>
                        )}
                    </main>
                    <footer className="z-10 mt-4 text-yellow-600/40 text-xs text-center">&copy; ç·šä¸Šåª½ç¥–éˆç±¤ | æ™ºæ…§æŒ‡å¼•ç‰ˆ V27</footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MazuTempleV27 />);
    </script>
</body>
</html>