<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>線上靈籤 | 天后宮 & 黃大仙</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Serif TC', serif; background-color: #292524; color: #fef3c7; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .writing-vertical { writing-mode: vertical-rl; }
        
        @keyframes toss-left { 
            0% { transform: translateY(0) rotateX(0) rotateZ(0); } 
            50% { transform: translateY(-150px) rotateX(720deg) rotateZ(-30deg); } 
            100% { transform: translateY(0) rotateX(var(--rotate-end-left)) rotateZ(15deg); } 
        }
        @keyframes toss-right { 
            0% { transform: translateY(0) rotateX(0) rotateZ(0); } 
            50% { transform: translateY(-150px) rotateX(720deg) rotateZ(30deg); } 
            100% { transform: translateY(0) rotateX(var(--rotate-end-right)) rotateZ(-15deg); } 
        }
        .animate-toss-left { animation: toss-left 1.5s ease-out forwards; }
        .animate-toss-right { animation: toss-right 1.5s ease-out forwards; }
        
        @keyframes container-shake { 
            0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-5deg) translateY(-5px); } 75% { transform: rotate(5deg) translateY(-5px); } 
        }
        .animate-shake-hard { animation: container-shake 0.1s infinite; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const STEPS = {
            INTRO: 0,
            INPUT: 1,
            ASK_PERMISSION: 2,
            SHAKING: 3,
            PICK_LOT: 4,
            CONFIRM_LOT: 5,
            AI_ANALYZING: 6,
            RESULT: 7
        };

        // --- 完整媽祖六十甲子籤資料庫 (V34 Stable - Keys Quoted) ---
        // 資料來源：北港朝天宮/新港奉天宮通用版本
        const MAZU_LOTS = [
            {id:1,t:'甲子',l:'大吉',s:'包公請雷驚仁宗',p:['日出便見風雲散','光明清淨照世間','一向前途通大道','萬事清吉保平安'],j:{'功名':'顯榮','月令':'月圓','婚姻':'成者','財利':'十分','治病':'痊癒','尋人':'得回','官事':'有理','家運':'平安'}},
            {id:2,t:'甲寅',l:'中吉',s:'於今此景正當時',p:['於今此景正當時','看看欲吐百花魁','若能遇得春色到','一灑清吉脫塵埃'],j:{'功名':'有貴','月令':'平平','婚姻':'和合','財利':'晚成','治病':'春癒','尋人':'南方','官事':'勝訴','家運':'漸興'}},
            {id:3,t:'甲辰',l:'中吉',s:'朱德武入寺相分明',p:['勸君把定心莫虛','天註衣祿自有餘','和合重重常吉慶','時來終遇得明珠'],j:{'功名':'後科','月令':'漸好','婚姻':'大吉','財利':'有','治病':'安','尋人':'見','官事':'吉','家運':'安'}},
            {id:4,t:'甲午',l:'中平',s:'盧龍王次子招親',p:['風恬浪靜可行舟','恰是中秋月一輪','凡事不須多憂慮','福祿自有慶家門'],j:{'功名':'有','月令':'好','婚姻':'合','財利':'有','治病':'癒','尋人':'至','官事':'和','家運':'隆'}},
            {id:5,t:'甲申',l:'中平',s:'龐統遇難',p:['只恐前途命有變','勸君作急可宜先','且守長江無大事','命逢太白守身邊'],j:{'功名':'難','月令':'變','婚姻':'變','財利':'無','治病':'險','尋人':'杳','官事':'凶','家運':'變'}},
            {id:6,t:'甲戌',l:'中平',s:'孔明出師',p:['風雲致雨落洋洋','天災時氣必有傷','命內此事難和合','更逢一足出外鄉'],j:{'功名':'無','月令':'凶','婚姻':'不合','財利':'無','治病':'險','尋人':'杳','官事':'虧','家運':'不寧'}},
            {id:7,t:'乙丑',l:'下下',s:'孟姜女送寒衣',p:['雲開月出正分明','不須進退問前程','婚姻皆由天註定','和合清吉萬事成'],j:{'功名':'無望','月令':'淡淡','婚姻':'不吉','財利':'微薄','治病':'拖延','尋人':'難見','官事':'和解','家運':'守成'}},
            {id:8,t:'乙卯',l:'中平',s:'孫悟空大難火災',p:['禾稻看看結成完','此事必定兩相全','回到家中寬心坐','妻兒鼓舞樂團圓'],j:{'功名':'少','月令':'中平','婚姻':'合','財利':'平','治病':'安','尋人':'見','官事':'拖','家運':'團圓'}},
            {id:9,t:'乙巳',l:'下籤',s:'龍虎相隨在深山',p:['龍虎相隨在深山','君爾何須背後看','不知身在千山外','直待虎頭人看版'],j:{'功名':'阻','月令':'平','婚姻':'隨緣','財利':'微','治病':'求神','尋人':'難','官事':'和','家運':'祈福'}},
            {id:10,t:'乙未',l:'中吉',s:'李旦龍鳳配',p:['花開結子一半枯','可惜今年汝虛度','漸漸日落西山去','勸君不用向前途'],j:{'功名':'難','月令':'難','婚姻':'不合','財利':'無','治病':'險','尋人':'無','官事':'凶','家運':'不順'}},
            {id:11,t:'乙酉',l:'上吉',s:'韓信拜將',p:['靈雞漸漸見分明','凡事且看子丑寅','雲開月出照天下','郎君即便見太平'],j:{'功名':'顯','月令':'吉','婚姻':'成','財利':'有','治病':'癒','尋人':'至','官事':'勝','家運':'隆'}},
            {id:12,t:'乙亥',l:'上吉',s:'薛仁貴投軍',p:['長江風浪漸漸靜','于今得進可安寧','比下月下言人少','只恐前途命有窮'],j:{'功名':'顯','月令':'吉','婚姻':'成','財利':'有','治病':'癒','尋人':'至','官事':'勝','家運':'隆'}},
            {id:13,t:'丙子',l:'下下',s:'郭華醉酒誤佳期',p:['命內正逢羅孛關','用盡心機總未休','作福問神難得過','恰是行舟上高灘'],j:{'功名':'無','月令':'不吉','婚姻':'不吉','財利':'失','治病':'險','尋人':'杳','官事':'虧','家運':'不寧'}},
            {id:14,t:'丙寅',l:'中平',s:'劉備入蜀',p:['財中漸漸見分明','花開花謝結子成','寬心且看月中桂','郎君即便見太平'],j:{'功名':'顯','月令':'漸好','婚姻':'成','財利':'有','治病':'安','尋人':'至','官事':'吉','家運':'平'}},
            {id:15,t:'丙辰',l:'上吉',s:'楊六郎斬子',p:['八十原來是太公','看看晚景遇文王','目下緊事休相問','勸君且守待運通'],j:{'功名':'晚','月令':'平','婚姻':'平','財利':'晚','治病':'老癒','尋人':'慢','官事':'吉','家運':'平'}},
            {id:16,t:'丙午',l:'平吉',s:'李世民遊地府',p:['不須作福不須求','用盡心機總未休','陽世不知陰世事','官法如爐不自由'],j:{'功名':'難','月令':'不順','婚姻':'不合','財利':'無','治病':'險','尋人':'無','官事':'凶','家運':'不順'}},
            {id:17,t:'丙申',l:'上吉',s:'寇準背靴',p:['舊恨重重未改為','家中禍患不臨身','須當謹防宜作福','龍蛇交會得和合'],j:{'功名':'顯','月令':'吉','婚姻':'成','財利':'有','治病':'安','尋人':'至','官事':'勝','家運':'隆'}},
            {id:18,t:'丙戌',l:'中平',s:'曹操遇華容道',p:['君問中間此言因','看看祿馬拱前程','若得貴人多得利','和合自有兩分明'],j:{'功名':'有','月令':'平','婚姻':'成','財利':'有','治病':'癒','尋人':'見','官事':'吉','家運':'安'}},
            {id:19,t:'丁丑',l:'上上',s:'韓信築壇拜將',p:['富貴由命天註定','心高必然誤君期','不然且回依舊路','雲開月出自分明'],j:{'功名':'顯','月令':'吉','婚姻':'成','財利':'有','治病':'癒','尋人':'至','官事':'勝','家運':'隆'}},
            {id:20,t:'丁卯',l:'中吉',s:'蘇武牧羊',p:['前途功名未得意','只恐命內運未通','兩家深利同合意','湧身解此月中風'],j:{'功名':'通','月令':'吉','婚姻':'合','財利':'有','治病':'安','尋人':'見','官事':'吉','家運':'順'}},
            {id:21,t:'丁巳',l:'中平',s:'薛仁貴回家',p:['十方佛法有靈通','大難禍患不相同','紅日當空常照耀','還有貴人到家堂'],j:{'功名':'望','月令':'平','婚姻':'合','財利':'平','治病':'癒','尋人':'見','官事':'和','家運':'安'}},
            {id:22,t:'丁未',l:'中吉',s:'曹操賜雲長馬袍',p:['太公家業八十成','月出光輝四海明','命內自然逢大吉','茅屋中間百事亨'],j:{'功名':'有','月令':'吉','婚姻':'成','財利':'利','治病':'安','尋人':'至','官事':'可','家運':'平'}},
            {id:23,t:'丁酉',l:'下下',s:'周瑜病亡',p:['欲去長江水闊茫','行舟把定未遭風','戶內用心再作福','看看魚水得相逢'],j:{'功名':'顯','月令':'吉','婚姻':'成','財利':'有','治病':'安','尋人':'至','官事':'勝','家運':'隆'}},
            {id:24,t:'丁亥',l:'中吉',s:'竇娥冤',p:['月出光輝本清吉','浮雲總是蔽陰色','戶內用心再作福','當官分理便有益'],j:{'功名':'無','月令':'平','婚姻':'平','財利':'平','治病':'險','尋人':'難','官事':'和','家運':'安'}},
            {id:25,t:'戊子',l:'下下',s:'李世民落海灘',p:['總是前途莫心勞','求神問聖枉是多','但看雞犬日過後','不須作福事如何'],j:{'功名':'難','月令':'凶','婚姻':'凶','財利':'無','治病':'險','尋人':'杳','官事':'凶','家運':'衰'}},
            {id:26,t:'戊寅',l:'上上',s:'李白醉酒撈月',p:['選出牡丹第一枝','勸君折取莫遲疑','世間若問相知處','萬事逢春正及時'],j:{'功名':'顯','月令':'吉','婚姻':'成','財利':'有','治病':'癒','尋人':'至','官事':'勝','家運':'隆'}},
            {id:27,t:'戊辰',l:'中吉',s:'石崇被難',p:['君爾寬心且自由','門庭清吉家無憂','財寶自然終吉利','凡事無傷不用求'],j:{'功名':'守','月令':'平','婚姻':'平','財利':'無','治病':'求神','尋人':'難','官事':'和','家運':'守'}},
            {id:28,t:'戊午',l:'中平',s:'孔明大戰馬謖',p:['於今莫作此當時','虎落平陽被犬欺','世間凡事何難定','千山萬水也遲疑'],j:{'功名':'顯','月令':'吉','婚姻':'成','財利':'有','治病':'癒','尋人':'見','官事':'吉','家運':'慶'}},
            {id:29,t:'戊申',l:'中吉',s:'范少伯泛舟',p:['枯木可惜未逢春','如今還在暗中藏','寬心且守風霜退','還君依舊作乾坤'],j:{'功名':'顯','月令':'吉','婚姻':'成','財利':'有','治病':'癒','尋人':'至','官事':'勝','家運':'隆'}},
            {id:30,t:'戊戌',l:'中平',s:'包公問郭槐',p:['漸漸看此月中和','過後須防未得高','改變顏色前途去','凡事必定見重勞'],j:{'功名':'無','月令':'平','婚姻':'平','財利':'平','治病':'險','尋人':'難','官事':'和','家運':'安'}},
            {id:31,t:'己丑',l:'上吉',s:'劉智遠得岳氏',p:['綠柳蒼蒼正當時','任君此去作乾坤','花果結實無殘謝','福祿自有慶家門'],j:{'功名':'顯','月令':'平','婚姻':'成','財利':'有','治病':'安','尋人':'至','官事':'吉','家運':'順'}},
            {id:32,t:'己卯',l:'中吉',s:'薛丁山著飛刀',p:['龍虎相交在門前','此事必定兩相連','黃金忽然變成鐵','何用作福問神仙'],j:{'功名':'有','月令':'平','婚姻':'合','財利':'平','治病':'癒','尋人':'見','官事':'和','家運':'安'}},
            {id:33,t:'己巳',l:'中平',s:'李旦龍鳳配',p:['欲去長江水闊茫','行舟把定未遭風','戶內用心再作福','看看魚水得相逢'],j:{'功名':'望','月令':'平','婚姻':'合','財利':'有','治病':'癒','尋人':'見','官事':'和','家運':'安'}},
            {id:34,t:'己未',l:'下下',s:'姜太公八十遇文王',p:['危險高山行過盡','莫嫌此路有重重','若見蘭桂漸漸發','去蛇反轉變成龍'],j:{'功名':'晚','月令':'平','婚姻':'平','財利':'晚','治病':'老癒','尋人':'慢','官事':'吉','家運':'平'}},
            {id:35,t:'己酉',l:'上吉',s:'李靖歸山',p:['此事何須用心機','前途變怪自然知','看看此去得和合','漸漸脫出見太平'],j:{'功名':'有','月令':'平','婚姻':'合','財利':'有','治病':'安','尋人':'見','官事':'和','家運':'安'}},
            {id:36,t:'己亥',l:'中平',s:'蘇東坡遊江',p:['福如東海壽如山','君爾何須嘆苦難','命內自然逢大吉','祈保分明得平安'],j:{'功名':'顯','月令':'吉','婚姻':'成','財利':'有','治病':'安','尋人':'至','官事':'勝','家運':'隆'}},
            {id:37,t:'庚子',l:'中吉',s:'周瑜曹操爭江北',p:['運逢得意身顯變','君爾身中皆有益','一向前途無難事','決意之中保清吉'],j:{'功名':'有','月令':'圓','婚姻':'成','財利':'有','治病':'癒','尋人':'至','官事':'吉','家運':'慶'}},
            {id:38,t:'庚寅',l:'中平',s:'趙子龍救阿斗',p:['名顯有意在中央','不須祈禱心自安','看看早晚日過後','即時得意在中間'],j:{'功名':'有','月令':'平','婚姻':'成','財利':'平','治病':'安','尋人':'至','官事':'吉','家運':'安'}},
            {id:39,t:'庚辰',l:'中吉',s:'唐明皇遊月宮',p:['意中若問神仙路','勸爾且退望高樓','寬心且守寬心坐','必然遇得貴人扶'],j:{'功名':'守','月令':'平','婚姻':'平','財利':'無','治病':'求神','尋人':'難','官事':'和','家運':'守'}},
            {id:40,t:'庚午',l:'下下',s:'蔡伯喈娘子遇虎',p:['平生富貴成祿位','君家門戶定光輝','此中必定無損失','夫妻百歲喜相隨'],j:{'功名':'無','月令':'平','婚姻':'平','財利':'平','治病':'拖','尋人':'難','官事':'吉','家運':'平'}},
            {id:41,t:'庚申',l:'中吉',s:'江東得道',p:['今行到手實難推','歌歌暢飲自徘徊','雞犬相聞消息近','婚姻夙世結成雙'],j:{'功名':'顯','月令':'吉','婚姻':'成','財利':'有','治病':'癒','尋人':'至','官事':'勝','家運':'隆'}},
            {id:42,t:'庚戌',l:'中平',s:'孟嘗君雞鳴度關',p:['一重江水一重山','誰知此去路又難','任他改求終不過','是非到底未得安'],j:{'功名':'有','月令':'平','婚姻':'好','財利':'利','治病':'安','尋人':'至','官事':'吉','家運':'安'}},
            {id:43,t:'辛丑',l:'上吉',s:'宋仁宗認母',p:['一年作事急如飛','君爾寬心莫遲疑','貴人還在千里外','音信月中漸漸知'],j:{'功名':'晚','月令':'平','婚姻':'成','財利':'晚','治病':'慢','尋人':'至','官事':'和','家運':'平'}},
            {id:44,t:'辛卯',l:'中吉',s:'蘇武牧羊',p:['客到前途多得利','君爾何故兩相疑','雖是中間逢進退','月出光輝得運時'],j:{'功名':'有','月令':'吉','婚姻':'合','財利':'有','治病':'安','尋人':'見','官事':'吉','家運':'安'}},
            {id:45,t:'辛巳',l:'下下',s:'三叔嫂記',p:['花開今已結成果','富貴榮華終到老','君子小人相會合','萬事清吉莫煩惱'],j:{'功名':'無','月令':'凶','婚姻':'凶','財利':'失','治病':'險','尋人':'杳','官事':'凶','家運':'衰'}},
            {id:46,t:'辛未',l:'中吉',s:'劉備求賢',p:['功名得位與君顯','前途富貴喜安然','若遇一輪明月照','十五團圓光滿天'],j:{'功名':'無','月令':'暗','婚姻':'難','財利':'無','治病':'拖','尋人':'難','官事':'和','家運':'守'}},
            {id:47,t:'辛酉',l:'上上',s:'莊子破棺',p:['君爾何須問聖跡','自己心中皆有益','於今且看月中旬','凶事脫出化成吉'],j:{'功名':'不遂','月令':'變','婚姻':'不合','財利':'無','治病':'險','尋人':'杳','官事':'凶','家運':'變'}},
            {id:48,t:'辛亥',l:'中平',s:'曹操遇關公',p:['陽世作事未和同','雲遮月色正朦朧','心中意欲前途去','只恐命內運未通'],j:{'功名':'無','月令':'暗','婚姻':'難','財利':'無','治病':'拖','尋人':'難','官事':'和','家運':'守'}},
            {id:49,t:'壬子',l:'中吉',s:'蘇琴碎琴',p:['言語雖多不可從','風雲靜處未行龍','暗中終得明消息','君爾何須問重重'],j:{'功名':'有','月令':'吉','婚姻':'好','財利':'有','治病':'安','尋人':'見','官事':'吉','家運':'慶'}},
            {id:50,t:'壬寅',l:'中平',s:'薛平貴別妻',p:['佛前發誓無異心','且看前途得好音','此物原來本是鐵','也能變化得成金'],j:{'功名':'有','月令':'吉','婚姻':'合','財利':'有','治病':'癒','尋人':'見','官事':'吉','家運':'平'}},
            {id:51,t:'壬辰',l:'中吉',s:'周瑜請孔明',p:['東西南北不堪行','前途此事正可當','勸君把定莫煩惱','家門自有保安康'],j:{'功名':'難','月令':'凶','婚姻':'平','財利':'無','治病':'求神','尋人':'難','官事':'和','家運':'守'}},
            {id:52,t:'壬午',l:'下下',s:'關公斬蔡陽',p:['功名事業本由天','不須掛念意懸懸','若問中間遲與速','風雲際會在眼前'],j:{'功名':'有','月令':'平','婚姻':'合','財利':'有','治病':'安','尋人':'至','官事':'吉','家運':'安'}},
            {id:53,t:'壬申',l:'中平',s:'楊文廣被困',p:['看君來問心中事','積善之家慶有餘','運亨財子雙雙至','指日喜氣溢門閭'],j:{'功名':'晚','月令':'平','婚姻':'慢','財利':'無','治病':'拖','尋人':'難','官事':'和','家運':'守'}},
            {id:54,t:'壬戌',l:'上吉',s:'三元會',p:['孤燈寂寂夜沉沉','萬事清吉萬事成','若逢陰世所注解','必定遭殃禍入門'],j:{'功名':'顯','月令':'吉','婚姻':'好','財利':'有','治病':'安','尋人':'至','官事':'勝','家運':'隆'}},
            {id:55,t:'癸丑',l:'中吉',s:'董永賣身',p:['須知進退總虛言','看看發暗未必全','珠玉深藏還未變','心中但得枉徒然'],j:{'功名':'有','月令':'平','婚姻':'成','財利':'有','治病':'癒','尋人':'見','官事':'吉','家運':'慶'}},
            {id:56,t:'癸卯',l:'中平',s:'溫金姑思親',p:['病中若得苦心勞','到底完全總未遭','去後不須回頭問','心中事務盡消磨'],j:{'功名':'難','月令':'凶','婚姻':'難','財利':'無','治病':'險','尋人':'杳','官事':'虧','家運':'不寧'}},
            {id:57,t:'癸巳',l:'中吉',s:'韓文公過秦嶺',p:['勸君把定心莫虛','天註衣祿自有餘','和合重重常吉慶','時來終遇得明珠'],j:{'功名':'晚','月令':'平','婚姻':'成','財利':'晚','治病':'慢','尋人':'至','官事':'和','家運':'平'}},
            {id:58,t:'癸未',l:'下下',s:'姜維吃水',p:['蛇身意欲變成龍','只恐命內運未通','久滯尚須大器晚','百鍊金剛始成鋼'],j:{'功名':'顯','月令':'吉','婚姻':'成','財利':'有','治病':'安','尋人':'至','官事':'勝','家運':'隆'}},
            {id:59,t:'癸酉',l:'上吉',s:'孔明祭七星',p:['有心作福莫遲疑','名利名山與利基','三箭開雲終有日','江山依舊是古碑'],j:{'功名':'有','月令':'平','婚姻':'成','財利':'平','治病':'安','尋人':'見','官事':'吉','家運':'安'}},
            {id:60,t:'癸亥',l:'上上',s:'楊六郎掛帥',p:['月出光輝本清吉','浮雲總是蔽陰色','戶內用心再作福','當官分理便有益'],j:{'功名':'顯','月令':'吉','婚姻':'成','財利':'有','治病':'癒','尋人':'至','官事':'勝','家運':'隆'}}
        ];

        // --- 完整黃大仙 100 籤資料庫 (Keys Quoted) ---
        const WTS_LOTS = [
            {id:1,l:'上上',s:'姜公封相',p:['靈籤求得第一枝','龍虎風雲際會時','一旦凌霄揚自樂','任君來往赴瑤池'],j:{功名:'大吉',財利:'正財',婚姻:'美滿',家宅:'興旺',自身:'平安',求謀:'遂意',疾病:'即癒',出行:'順利'}},
            {id:2,l:'上吉',s:'王道真誤入桃源',p:['枯木逢春盡發新','花香葉茂蝶來頻','桃源競鬥千紅紫','一葉漁舟誤入津'],j:{功名:'有成',財利:'微利',婚姻:'和合',家宅:'安寧',自身:'吉利',求謀:'順遂',疾病:'可癒',出行:'平安'}},
            {id:3,l:'中平',s:'魯班開山',p:['牛山之木皆常美','獨惜斧工盡伐他','大器大材無足用','規矩不準怎為槎'],j:{功名:'難成',財利:'微薄',婚姻:'不合',家宅:'平常',自身:'修養',求謀:'難遂',疾病:'拖延',出行:'不利'}},
            {id:4,l:'中吉',s:'董永遇仙',p:['調雛紫燕在簷前','對語呢喃近午天','或往或來低復起','有時剪破綠楊煙'],j:{功名:'可望',財利:'有益',婚姻:'合',家宅:'吉',自身:'安',求謀:'可成',疾病:'無礙',出行:'吉'}},
            {id:5,l:'中吉',s:'韓夫人惜花',p:['東園昨夜狂風急','萬紫千紅亦盡傾','幸有惜花人早起','培回根本復栽生'],j:{功名:'有阻',財利:'待時',婚姻:'阻礙',家宅:'修整',自身:'謹慎',求謀:'苦後甘',疾病:'反覆',出行:'遲滯'}},
            {id:6,l:'上吉',s:'王羲之歸故里',p:['一片孤帆萬里回','管絃嘔啞且停杯','如雲勝友談風月','暢敘幽情極樂哉'],j:{功名:'顯達',財利:'豐收',婚姻:'美滿',家宅:'喜慶',自身:'康泰',求謀:'遂意',疾病:'即癒',出行:'大吉'}},
            {id:7,l:'中吉',s:'仁貴歸家',p:['秋水蒹葭白露盈','盈庭月色浸階清','清風吹動馬鈴響','響接晨鐘不斷聲'],j:{功名:'將成',財利:'平平',婚姻:'合',家宅:'漸佳',自身:'安',求謀:'有成',疾病:'漸癒',出行:'快至'}},
            {id:8,l:'下下',s:'崔子弒父',p:['鳴鳩爭奪鵲巢居','賓主參差意不舒','滿嶺喬松蘿蔦附','且猜詩語是何如'],j:{功名:'無望',財利:'失財',婚姻:'離異',家宅:'不寧',自身:'險阻',求謀:'不成',疾病:'凶',出行:'不宜'}},
            {id:9,l:'上吉',s:'陶淵明賞菊',p:['瑤琴一曲奏新腔','明月清風枕簟涼','咸集嘉賓同賞菊','或歌或舞或飛觴'],j:{功名:'高遷',財利:'大有',婚姻:'偕老',家宅:'昌盛',自身:'快樂',求謀:'必得',疾病:'即安',出行:'順風'}},
            {id:10,l:'中平',s:'蘇秦不第',p:['一輪月鏡掛空中','偶被浮雲障羽隆','玉魄本光無所損','少叫雲散便當空'],j:{功名:'待時',財利:'未有',婚姻:'遲成',家宅:'平平',自身:'忍耐',求謀:'暫阻',疾病:'可醫',出行:'遲'}},
            {id:11,l:'上吉',s:'漢文帝賞柳',p:['楊柳垂堤鎖綠煙','日長三起又三眠','往來紫燕紛飛舞','裊娜迎風倩我看'],j:{功名:'顯耀',財利:'順遂',婚姻:'和合',家宅:'吉慶',自身:'安康',求謀:'如意',疾病:'無礙',出行:'通達'}},
            {id:12,l:'下下',s:'太白撈月',p:['蜃樓海市幻無邊','萬丈擎空接上天','或被狂風忽吹散','有時仍聚結青煙'],j:{功名:'虛幻',財利:'空求',婚姻:'不成',家宅:'虛驚',自身:'浮沉',求謀:'無望',疾病:'險',出行:'阻隔'}},
            {id:13,l:'中平',s:'孟浩然尋梅',p:['嶺南初放一枝梅','片片晶瑩入酒杯','卻遇騎驢人早至','兒童背負占春魁'],j:{功名:'晚成',財利:'小利',婚姻:'平常',家宅:'安',自身:'勞碌',求謀:'勤得',疾病:'慢癒',出行:'吉'}},
            {id:14,l:'中吉',s:'蘇東坡醉酒',p:['為愛幽閒多種竹','買春賞雨在茅屋','醉時臥倒杏花邊','怕聽鶯兒驚夢熟'],j:{功名:'無求',財利:'隨緣',婚姻:'隨意',家宅:'清吉',自身:'逍遙',求謀:'順其自然',疾病:'無礙',出行:'可'}},
            {id:15,l:'上吉',s:'明皇遊月殿',p:['仙槎一葉報佳音','意氣風發上九天','要看嫦娥修月殿','廣寒宮內好團圓'],j:{功名:'大貴',財利:'大富',婚姻:'極佳',家宅:'光輝',自身:'發達',求謀:'必成',疾病:'即癒',出行:'大吉'}},
            {id:16,l:'中吉',s:'皇叔遇水鏡',p:['天邊鴉背夕陽回','隴外兒童跨犢來','羌笛頻吹聲切耳','短長腔調樂何哉'],j:{功名:'將至',財利:'漸有',婚姻:'合',家宅:'安',自身:'樂',求謀:'遇貴人',疾病:'癒',出行:'歸家'}},
            {id:17,l:'中吉',s:'月下追賢',p:['秋水蒹葭白露盈','盈庭月色浸階清','清風吹動馬鈴響','響接晨鐘不斷聲'],j:{功名:'有望',財利:'勤求',婚姻:'好',家宅:'吉',自身:'忙碌',求謀:'可成',疾病:'漸安',出行:'利'}},
            {id:18,l:'下下',s:'杜鵑泣血',p:['杜鵑啼血淚悲聲','聲怨霜寒夢戶驚','驚動異鄉為異客','客心更觸故園情'],j:{功名:'無',財利:'破財',婚姻:'凶',家宅:'不寧',自身:'愁苦',求謀:'艱難',疾病:'重',出行:'不宜'}},
            {id:19,l:'中吉',s:'伏羲畫八卦',p:['乾卦三連號順天','坤六斷處信地緣','八卦循環無休歇','造化無為本自然'],j:{功名:'順遂',財利:'有',婚姻:'和',家宅:'安',自身:'吉',求謀:'成',疾病:'癒',出行:'平'}},
            {id:20,l:'中平',s:'雪梅招親',p:['天上仙花難問種','人間塵事幾多更','前程已註公私簿','罰賞分明濁與清'],j:{功名:'平常',財利:'平穩',婚姻:'緣份',家宅:'一般',自身:'守分',求謀:'難',疾病:'保養',出行:'中'}},
            {id:21,l:'中吉',s:'武則天賞花',p:['天外紅霞如抹錦','門檻月影似鋪銀','一樽美酒邀明月','萬朵鮮花對美人'],j:{功名:'顯',財利:'旺',婚姻:'美',家宅:'吉',自身:'榮',求謀:'遂',疾病:'安',出行:'利'}},
            {id:22,l:'下下',s:'陳妙嫦思春',p:['秋水依人各一方','天南地北恨偏長','相思試問憑誰寄','不盡悽涼狂斷腸'],j:{功名:'無',財利:'無',婚姻:'離',家宅:'悶',自身:'苦',求謀:'不成',疾病:'憂',出行:'阻'}},
            {id:23,l:'中平',s:'盧生夢',p:['邯鄲一夢幻無邊','數載身榮是熟眠','換郤錦衣歸故里','睡醒還記在心田'],j:{功名:'虛',財利:'小',婚姻:'平',家宅:'常',自身:'醒悟',求謀:'虛',疾病:'醫',出行:'歸'}},
            {id:24,l:'下下',s:'白居易歸隱',p:['詩名赫奕震長安','布穀催春怨雨殘','早起歸休尋舊窟','南山猿鶴怨無端'],j:{功名:'退',財利:'散',婚姻:'難',家宅:'變',自身:'隱',求謀:'阻',疾病:'延',出行:'阻'}},
            {id:25,l:'上吉',s:'朱洪武登基',p:['群山擾擾朝中嶽','有似為臣列鵠班','拱立兩行齊整肅','自今宇內定尊閑'],j:{功名:'高',財利:'厚',婚姻:'成',家宅:'隆',自身:'吉',求謀:'遂',疾病:'除',出行:'暢'}},
            {id:26,l:'中平',s:'徐庶歸家',p:['花影遲遲侵砌上','遙知月鏡掛長空','忽聞鶴唳聲淒切','早買歸舟返里中'],j:{功名:'遲',財利:'平',婚姻:'待',家宅:'想家',自身:'安',求謀:'緩',疾病:'防',出行:'歸'}},
            {id:27,l:'中平',s:'越王復國',p:['天晴玄鳥雙雙飛','吳越參差時去歸','回首舊棲新主出','幾多艱苦願無違'],j:{功名:'復',財利:'勞',婚姻:'合',家宅:'興',自身:'苦盡',求謀:'成',疾病:'癒',出行:'利'}},
            {id:28,l:'中平',s:'白居易聽琵琶',p:['船泊潯陽月夜明','琵琶一曲動人情','相逢似是天涯客','說盡心中無限聲'],j:{功名:'無',財利:'薄',婚姻:'友',家宅:'平',自身:'感',求謀:'知音',疾病:'調',出行:'順'}},
            {id:29,l:'中吉',s:'張翰思鱸',p:['鱸魚膾美酒香醇','或是中秋月色新','一棹歸舟穿白浪','採蓴還憶舊時人'],j:{功名:'退',財利:'足',婚姻:'念舊',家宅:'安',自身:'樂',求謀:'遂',疾病:'安',出行:'歸'}},
            {id:30,l:'下下',s:'貴妃自縊',p:['傾國傾城恨有餘','幾多紅粉抱琵琶','看他強馬終無用','一旦無常萬事休'],j:{功名:'失',財利:'損',婚姻:'破',家宅:'凶',自身:'危',求謀:'敗',疾病:'重',出行:'險'}},
            {id:31,l:'下下',s:'蔡中興遇險',p:['狂風驟雨打船篷','溪畔桃花盡落紅','驚醒漁翁春夢破','幾多心事總成空'],j:{功名:'廢',財利:'耗',婚姻:'離',家宅:'驚',自身:'險',求謀:'空',疾病:'災',出行:'阻'}},
            {id:32,l:'中平',s:'蘇武牧羊',p:['十九年前海上辛','節旄彫敗逐沙塵','餐毛嚼雪誰憐我','留得丹心照漢濱'],j:{功名:'遲',財利:'難',婚姻:'滯',家宅:'貧',自身:'苦',求謀:'艱',疾病:'久',出行:'遠'}},
            {id:33,l:'中平',s:'孔明借東風',p:['曹操雖有百萬兵','更無一計破孔明','借得東風攻敵去','全軍瓦解沒逃生'],j:{功名:'險中求',財利:'智取',婚姻:'合',家宅:'安',自身:'智',求謀:'成',疾病:'癒',出行:'利'}},
            {id:34,l:'中吉',s:'虞舜耕田',p:['大舜雖耕在歷山','心常孝順兩親顏','田中之象同家象','一般不但只一般'],j:{功名:'顯',財利:'有',婚姻:'善',家宅:'睦',自身:'順',求謀:'遂',疾病:'安',出行:'吉'}},
            {id:35,l:'中吉',s:'唐僧取經',p:['天將降任與其人','必先勞碌苦其身','若不經過勤與苦','焉能取得經卷真'],j:{功名:'苦後甜',財利:'勤得',婚姻:'堅',家宅:'安',自身:'煉',求謀:'成',疾病:'療',出行:'遠'}},
            {id:36,l:'中吉',s:'薛平貴歸家',p:['此事真如到岸船','何憂風浪不週全','一生受盡艱辛苦','這番名利兩相全'],j:{功名:'成',財利:'全',婚姻:'合',家宅:'吉',自身:'安',求謀:'遂',疾病:'癒',出行:'至'}},
            {id:37,l:'上吉',s:'東坡遊赤壁',p:['月夜舟中赤壁遊','齊名三國姓名留','千古風流人物在','昔年一戰在荊州'],j:{功名:'有',財利:'豐',婚姻:'合',家宅:'旺',自身:'吉',求謀:'遂',疾病:'除',出行:'快'}},
            {id:38,l:'中吉',s:'陶淵明辭官',p:['歸去來兮歲月斜','秋風老圃看黃花','雖然未得高官做','且是無憂快樂家'],j:{功名:'捨',財利:'足',婚姻:'和',家宅:'樂',自身:'安',求謀:'平',疾病:'無',出行:'歸'}},
            {id:39,l:'中吉',s:'夷齊讓國',p:['夷齊不忍食周粟','兄弟心同去首陽','抱節清名留萬古','至今千載有餘香'],j:{功名:'虛',財利:'淡',婚姻:'和',家宅:'安',自身:'清',求謀:'難',疾病:'安',出行:'阻'}},
            {id:40,l:'下下',s:'伯牙碎琴',p:['古琴雖好少知音','弦斷誰憐一片心','若得知音人聽採','一律彈來值萬金'],j:{功名:'無',財利:'無',婚姻:'孤',家宅:'冷',自身:'悲',求謀:'難',疾病:'拖',出行:'阻'}},
            {id:41,l:'中吉',s:'張騫獲寶石',p:['浮槎月夜到天河','曾見天星似織梭','石得支機人罕識','那知此寶出絲羅'],j:{功名:'顯',財利:'得',婚姻:'成',家宅:'吉',自身:'安',求謀:'遂',疾病:'醫',出行:'利'}},
            {id:42,l:'中吉',s:'王允獻貂嬋',p:['月明散步到花欄','無策焉能剿滅奸','幸有貂蟬思定國','英雄難過美人關'],j:{功名:'計謀',財利:'險得',婚姻:'合',家宅:'安',自身:'吉',求謀:'成',疾病:'癒',出行:'利'}},
            {id:43,l:'下下',s:'韓文公被貶',p:['只因直諫觸龍顏','晝夜驅馳去度關','馬死風號天下雪','全憑湘子度藍關'],j:{功名:'失',財利:'耗',婚姻:'滯',家宅:'驚',自身:'危',求謀:'敗',疾病:'險',出行:'阻'}},
            {id:44,l:'中吉',s:'唐天寶評花',p:['滿園春色鬥新妝','意似爭妍奪國香','到底是誰居第一','梅花老圃薦孤芳'],j:{功名:'望',財利:'有',婚姻:'合',家宅:'吉',自身:'安',求謀:'成',疾病:'癒',出行:'利'}},
            {id:45,l:'中平',s:'王質遇仙',p:['採樵信步入深山','見兩仙翁在此間','局未終時柯已爛','歸家且喜日方閒'],j:{功名:'無',財利:'平',婚姻:'遲',家宅:'變',自身:'閒',求謀:'緩',疾病:'延',出行:'遠'}},
            {id:46,l:'下下',s:'左慈戲曹操',p:['黃金滿屋少人知','一旦逢春轉更遲','欲問前程何處去','一聲歸笛是何時'],j:{功名:'虛',財利:'失',婚姻:'難',家宅:'憂',自身:'險',求謀:'空',疾病:'重',出行:'阻'}},
            {id:47,l:'中平',s:'魯肅索荊州',p:['看花稱意在芳菲','花落風飄總若希','若得寸進宜退步','如周若始又重圍'],j:{功名:'滯',財利:'無',婚姻:'阻',家宅:'平',自身:'守',求謀:'難',疾病:'延',出行:'阻'}},
            {id:48,l:'中平',s:'卓文君賣酒',p:['繡球結下五花棚','故事傳聞在錦城','從此如龍添一角','半推半就作成親'],j:{功名:'可',財利:'有',婚姻:'合',家宅:'吉',自身:'安',求謀:'成',疾病:'癒',出行:'利'}},
            {id:49,l:'中吉',s:'司馬相如題橋',p:['十年窗下苦功修','今日飛騰上鳳樓','九萬里天風送我','青雲得路任遨遊'],j:{功名:'顯',財利:'厚',婚姻:'美',家宅:'旺',自身:'榮',求謀:'遂',疾病:'癒',出行:'吉'}},
            {id:50,l:'中吉',s:'伍員出關',p:['枯木逢春再發花','雨過天青獨自誇','此日過關樊籠破','任君來往走天涯'],j:{功名:'成',財利:'有',婚姻:'合',家宅:'吉',自身:'脫難',求謀:'遂',疾病:'癒',出行:'通'}},
            {id:51,l:'中平',s:'成王剪桐封第',p:['剪桐小戲也封王','可見天心重主張','富貴榮華天註定','五行生剋莫荒唐'],j:{功名:'有',財利:'平',婚姻:'合',家宅:'安',自身:'吉',求謀:'順',疾病:'安',出行:'利'}},
            {id:52,l:'中平',s:'盤古開天闢地',p:['盤古初開天地清','陰陽造化日光明','參差世事無相定','或是人生夢裡驚'],j:{功名:'未定',財利:'平',婚姻:'待',家宅:'安',自身:'慎',求謀:'疑',疾病:'防',出行:'阻'}},
            {id:53,l:'中吉',s:'馮曖客孟嘗',p:['珠履三千客孟嘗','誰人識得有鷹揚','其中彈鋏歸來者','便是英雄志氣長'],j:{功名:'望',財利:'有',婚姻:'合',家宅:'吉',自身:'榮',求謀:'遂',疾病:'癒',出行:'利'}},
            {id:54,l:'中平',s:'莊周夢蝶',p:['莊子逍遙達道經','夢迷魂蝶亦相應','任他富貴榮華事','幻化無常且暫停'],j:{功名:'虛',財利:'微',婚姻:'平',家宅:'安',自身:'悟',求謀:'空',疾病:'安',出行:'吉'}},
            {id:55,l:'中平',s:'吳隱之投沉香',p:['浦號沉香遺舊恨','渡江猶憶古人心','可憐當日辭官去','雖有馨留不易尋'],j:{功名:'退',財利:'散',婚姻:'平',家宅:'安',自身:'清',求謀:'難',疾病:'醫',出行:'歸'}},
            {id:56,l:'中吉',s:'呂祖桃木劍',p:['安知此劍不成龍','見水都應化作龍','第一鋒頭方有準','誅妖殺怪沐春風'],j:{功名:'成',財利:'有',婚姻:'吉',家宅:'安',自身:'吉',求謀:'遂',疾病:'除',出行:'利'}},
            {id:57,l:'中吉',s:'獨佔花魁',p:['小樓春雨聲初歇','徘徊街頭屐不停','忽聽賣花人入巷','一枝獨佔好春情'],j:{功名:'遂',財利:'得',婚姻:'合',家宅:'吉',自身:'安',求謀:'成',疾病:'癒',出行:'利'}},
            {id:58,l:'下下',s:'蹇叔哭師',p:['秦師大敗在殽山','三帥皆擒盡放還','蹇叔諫言因不聽','倒戈棄甲不堪看'],j:{功名:'敗',財利:'失',婚姻:'破',家宅:'凶',自身:'危',求謀:'敗',疾病:'重',出行:'險'}},
            {id:59,l:'下下',s:'東施效顰',p:['圖容西子貌嬋娟','誰知東施效顰難','不攝照磨偏自醜','更教人笑被人嫌'],j:{功名:'無',財利:'無',婚姻:'難',家宅:'衰',自身:'醜',求謀:'敗',疾病:'憂',出行:'阻'}},
            {id:60,l:'中平',s:'李白醉和番書',p:['和番書詔在忙中','醉倒金鑾酒尚濃','只有天才李太白','能將草詔嚇番戎'],j:{功名:'顯',財利:'平',婚姻:'合',家宅:'安',自身:'吉',求謀:'成',疾病:'癒',出行:'利'}},
            {id:61,l:'下下',s:'十二金牌召嶽飛',p:['十二金牌速召回','奸雄陰險欲成災','將軍一旦遭羅網','從此民間少將才'],j:{功名:'凶',財利:'失',婚姻:'破',家宅:'危',自身:'險',求謀:'敗',疾病:'重',出行:'忌'}},
            {id:62,l:'中平',s:'孔子守道',p:['孔聖刪書在韋編','龍門太史筆如椽','春秋筆法無私曲','筆削聲名四海傳'],j:{功名:'久',財利:'平',婚姻:'吉',家宅:'安',自身:'修',求謀:'成',疾病:'安',出行:'吉'}},
            {id:63,l:'中吉',s:'顏回樂道安貧',p:['陋巷簞瓢不足憂','傍人見了替他愁','不知樂道無窮樂','富貴榮華不到頭'],j:{功名:'淡',財利:'薄',婚姻:'和',家宅:'平',自身:'安',求謀:'隨',疾病:'無',出行:'可'}},
            {id:64,l:'中吉',s:'孟之反殿師',p:['奔殿當年膽氣雄','此間稱美孟之功','一心忠義無人識','不怕軍驚敗若風'],j:{功名:'成',財利:'有',婚姻:'合',家宅:'吉',自身:'勇',求謀:'遂',疾病:'癒',出行:'利'}},
            {id:65,l:'下下',s:'後主失國',p:['隋滅陳時已可知','陳兵未動國先危','井底胭脂波染紅','可憐後主在宮闈'],j:{功名:'敗',財利:'失',婚姻:'破',家宅:'傾',自身:'危',求謀:'絕',疾病:'凶',出行:'阻'}},
            {id:66,l:'上吉',s:'羲之會群賢',p:['蘭亭雅會眾群賢','曲水流觴在目前','快樂如斯真少有','有詩有畫樂安然'],j:{功名:'顯',財利:'豐',婚姻:'美',家宅:'昌',自身:'樂',求謀:'遂',疾病:'安',出行:'吉'}},
            {id:67,l:'中平',s:'李元霸稱雄',p:['人誇力氣舉千斤','四海為家又稱尊','若是匹夫無智慮','更教人笑沒精神'],j:{功名:'虛',財利:'有',婚姻:'平',家宅:'安',自身:'戒',求謀:'難',疾病:'防',出行:'阻'}},
            {id:68,l:'中吉',s:'姜太公得志',p:['久抱經綸未得施','渭川垂釣老鬚眉','皇天不負文王意','載得賢臣歸去來'],j:{功名:'成',財利:'有',婚姻:'合',家宅:'吉',自身:'順',求謀:'遂',疾病:'癒',出行:'利'}},
            {id:69,l:'中吉',s:'韓文公祭鱷魚',p:['忠義存心上達天','鱷魚為害少安然','文公一表祭鱷魚','去卻奇災福壽全'],j:{功名:'顯',財利:'有',婚姻:'合',家宅:'安',自身:'吉',求謀:'成',疾病:'除',出行:'利'}},
            {id:70,l:'中平',s:'塞翁失馬',p:['可比當年一塞翁','雖然失馬半途中','不知禍福真難測','幸得兒孫後來功'],j:{功名:'晚',財利:'復',婚姻:'合',家宅:'平',自身:'安',求謀:'順',疾病:'疑',出行:'吉'}},
            {id:71,l:'中平',s:'莊周活鮒魚',p:['涸轍之中鮒困之','呼號望救甚堪悲','若能引得西江水','他日成龍也未知'],j:{功名:'難',財利:'困',婚姻:'滯',家宅:'艱',自身:'苦',求謀:'待',疾病:'延',出行:'阻'}},
            {id:72,l:'中平',s:'高文定守困',p:['弄蜂須要求他蜜','只怕遭他尾上針','雖是眼前有異路','暗裏深藏荊棘林'],j:{功名:'無',財利:'險',婚姻:'防',家宅:'戒',自身:'慎',求謀:'阻',疾病:'防',出行:'止'}},
            {id:73,l:'上吉',s:'孫策怒殺于吉',p:['射鹿當年在此間','江東父老盡開顏','雖然項羽無雙勇','爭得中原百二山'],j:{功名:'顯',財利:'有',婚姻:'合',家宅:'吉',自身:'安',求謀:'成',疾病:'癒',出行:'利'}},
            {id:74,l:'下下',s:'朱買臣分妻',p:['回憶當年運蹇時','夫妻反目兩分離','名題雁塔歸來後','覆水馬頭時悔遲'],j:{功名:'遲',財利:'無',婚姻:'破',家宅:'變',自身:'悔',求謀:'難',疾病:'憂',出行:'阻'}},
            {id:75,l:'下下',s:'倫文敘戲妻',p:['婚姻豈可當兒戲','二姓合婚非易事','若不嚴肅終後悔','百年偕老費心機'],j:{功名:'無',財利:'微',婚姻:'險',家宅:'平',自身:'慎',求謀:'難',疾病:'拖',出行:'阻'}},
            {id:76,l:'中平',s:'孔明撫琴退仲達',p:['人能樂道自安居','何必奔波走四方','處處無非真樂地','何時花發不傳香'],j:{功名:'修',財利:'平',婚姻:'安',家宅:'吉',自身:'樂',求謀:'順',疾病:'安',出行:'可'}},
            {id:77,l:'中平',s:'公冶長入獄',p:['鳥語能通公冶長','南山虎豹把羊傷','雖然獲罪非為盜','夢裡囹圄無事殃'],j:{功名:'阻',財利:'失',婚姻:'驚',家宅:'不安',自身:'險',求謀:'難',疾病:'防',出行:'凶'}},
            {id:78,l:'上吉',s:'曾點瑟希',p:['瑟希鏗爾奏新聲','風乎舞雩詠歸亭','夫子當年曾點許','春風滿座樂昇平'],j:{功名:'遂',財利:'豐',婚姻:'美',家宅:'旺',自身:'樂',求謀:'成',疾病:'癒',出行:'吉'}},
            {id:79,l:'中吉',s:'張良拾履',p:['富貴榮華天註定','安邦定國盡忠貞','一旦功成身退後','長生不老過一生'],j:{功名:'成',財利:'有',婚姻:'合',家宅:'吉',自身:'安',求謀:'遂',疾病:'癒',出行:'利'}},
            {id:80,l:'中吉',s:'樂廣釋疑',p:['飛觴解化酒杯蛇','疑似消除福有加','從此清閒無一事','寬心飲酒醉流霞'],j:{功名:'顯',財利:'足',婚姻:'合',家宅:'安',自身:'樂',求謀:'成',疾病:'除',出行:'利'}},
            {id:81,l:'中平',s:'子路問事',p:['子路問事不問神','聖人答語最精真','若要問神先問己','修身積德福來臨'],j:{功名:'修',財利:'勤',婚姻:'吉',家宅:'安',自身:'省',求謀:'順',疾病:'醫',出行:'吉'}},
            {id:82,l:'中平',s:'孔子擊磬',p:['聖人擊磬在衛邦','荷蕢且過門邊廂','雖然心事無人識','也有知音細論量'],j:{功名:'遲',財利:'平',婚姻:'待',家宅:'安',自身:'守',求謀:'緩',疾病:'安',出行:'可'}},
            {id:83,l:'中平',s:'赤松子招隱',p:['星辰隱沒月無光','隱躍朦朧入睡鄉','夢裡不知身是客','醒來方覺在他鄉'],j:{功名:'無',財利:'平',婚姻:'平',家宅:'安',自身:'迷',求謀:'難',疾病:'防',出行:'阻'}},
            {id:84,l:'中平',s:'韓信棄楚歸漢',p:['滿腹奇才志未伸','棄楚歸漢遇知音','雖然一旦風雲會','也算英雄老逐心'],j:{功名:'遲',財利:'有',婚姻:'合',家宅:'吉',自身:'安',求謀:'成',疾病:'癒',出行:'利'}},
            {id:85,l:'中吉',s:'劉邦斬蛇',p:['太乙燃藜照讀書','十年窗下苦功夫','揚眉吐氣風雲際','金榜題名屬丈夫'],j:{功名:'顯',財利:'旺',婚姻:'美',家宅:'興',自身:'榮',求謀:'遂',疾病:'癒',出行:'吉'}},
            {id:86,l:'中吉',s:'侃母截髮',p:['截髮延賓傳美談','陶公運甓亦如然','其中極有真奇節','史策流芳萬古傳'],j:{功名:'成',財利:'有',婚姻:'賢',家宅:'吉',自身:'安',求謀:'遂',疾病:'癒',出行:'利'}},
            {id:87,l:'中平',s:'荀巨伯探病',p:['跋涉途程往探親','誰知好友病呻吟','夢中說話無人信','空使慈親痛在心'],j:{功名:'無',財利:'損',婚姻:'愁',家宅:'憂',自身:'苦',求謀:'阻',疾病:'凶',出行:'險'}},
            {id:88,l:'中吉',s:'花木蘭代父從軍',p:['代父從軍膽氣雄','忠心報國顯英雄','雖然身是女兒輩','一旦功成萬古崇'],j:{功名:'顯',財利:'有',婚姻:'遲',家宅:'吉',自身:'勇',求謀:'遂',疾病:'安',出行:'利'}},
            {id:89,l:'中平',s:'吳季子掛劍',p:['他鄉遠歷久淹留','歸到家鄉事轉愁','惟有解劍掛墳樹','才知心事不知休'],j:{功名:'無',財利:'無',婚姻:'悲',家宅:'愁',自身:'嘆',求謀:'難',疾病:'憂',出行:'苦'}},
            {id:90,l:'中平',s:'紅拂女私奔',p:['細雨春風濕翠翹','一鞭馬上逞妖嬌','相逢俠客紅塵外','配得英豪也不饒'],j:{功名:'可',財利:'平',婚姻:'合',家宅:'安',自身:'吉',求謀:'成',疾病:'癒',出行:'利'}},
            {id:91,l:'中吉',s:'月裡念奴',p:['蟾宮月殿桂飄香','玉兔長生搗藥忙','吳剛伐樹無休日','幸有嫦娥助淡妝'],j:{功名:'成',財利:'有',婚姻:'合',家宅:'吉',自身:'安',求謀:'遂',疾病:'癒',出行:'利'}},
            {id:92,l:'中吉',s:'孔子聞韶',p:['三月聞韶不知味','可憐夫子聽聲音','當時一國皆瘋狂','此曲只應天上聞'],j:{功名:'有',財利:'足',婚姻:'合',家宅:'吉',自身:'樂',求謀:'遂',疾病:'安',出行:'利'}},
            {id:93,l:'中平',s:'孔子歎鳳',p:['鳳鳥不至河無圖','微子淒涼歎道窮','唯有後人知此意','詩書傳誦萬年功'],j:{功名:'遲',財利:'平',婚姻:'待',家宅:'平',自身:'修',求謀:'難',疾病:'防',出行:'阻'}},
            {id:94,l:'中平',s:'劉琦奔江夏',p:['一派長江水向東','扁舟順水逞英雄','雖然風浪多驚險','還有貴人相助功'],j:{功名:'險',財利:'有',婚姻:'合',家宅:'安',自身:'吉',求謀:'成',疾病:'癒',出行:'利'}},
            {id:95,l:'下下',s:'女媧煉石',p:['功高補天少人知','煉石當年費心機','只恐蒼天還有漏','不教神女淚沾衣'],j:{功名:'無',財利:'耗',婚姻:'悲',家宅:'憂',自身:'勞',求謀:'難',疾病:'重',出行:'苦'}},
            {id:96,l:'中平',s:'文姬歸漢',p:['羌笛頻吹韻更悲','異鄉為客淚沾衣','幸得一朝歸漢室','方知今日是歸期'],j:{功名:'遲',財利:'平',婚姻:'合',家宅:'吉',自身:'苦盡',求謀:'成',疾病:'癒',出行:'歸'}},
            {id:97,l:'中吉',s:'康熙微服',p:['憑欄晚眺倚南樓','滿目風光景色幽','一葉小舟頻往來','箇中人去不知愁'],j:{功名:'顯',財利:'有',婚姻:'合',家宅:'安',自身:'樂',求謀:'遂',疾病:'無',出行:'利'}},
            {id:98,l:'中平',s:'管鮑分金',p:['入山種玉復分金','貴賤交情見此心','若得管鮑同心意','磨礱砥礪總成珍'],j:{功名:'有',財利:'平',婚姻:'合',家宅:'吉',自身:'安',求謀:'成',疾病:'癒',出行:'利'}},
            {id:99,l:'中平',s:'韓文公遇雪',p:['雪擁藍關馬不前','風吹號令滿驚天','雖然身在此中苦','還有韓湘在面前'],j:{功名:'阻',財利:'難',婚姻:'滯',家宅:'憂',自身:'苦',求謀:'待',疾病:'防',出行:'阻'}},
            {id:100,l:'中吉',s:'唐明皇賞花',p:['百花競放賀陽春','萬物從今盡轉新','末數莫言窮運至','不知否極泰來臨'],j:{功名:'顯',財利:'旺',婚姻:'美',家宅:'隆',自身:'吉',求謀:'遂',疾病:'癒',出行:'利'}}
        ];

        const generateWTSLots = () => {
            const lots = [...WTS_LOTS];
            const ids = new Set(lots.map(l => l.id));
            const poems = [['乘雲馭氣上天台','看見眾仙集會來','他日名標金榜上','榮華富貴不須猜'],['下得雲梯步步行','好音相伴更相親','今朝得志君心喜','他日榮華在後身']];
            for(let i=1; i<=100; i++) {
                if(!ids.has(i)) {
                    lots.push({
                        id:i, l:i%2===0?'上吉':'中平', s:`大仙典故${i}`, p:poems[i%2],
                        j:{'功名':'有','財利':'平','婚姻':'合','家宅':'吉','自身':'安','求謀':'順','疾病':'癒','出行':'利'}
                    });
                }
            }
            return lots.sort((a,b)=>a.id-b.id);
        };
        const WTS_LOTS_FULL = generateWTSLots();

        // --- Icons ---
        const IconBase = ({ d, className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d}/></svg>;
        const User = (p) => <IconBase {...p} d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2 M12 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8z" />;
        const Star = (p) => <IconBase {...p} d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />;
        const RotateCcw = (p) => <IconBase {...p} d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8 M3 3v5h5" />;
        const Download = (p) => <IconBase {...p} d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M7 10l5 5 5-5 M12 15V3" />;
        const X = (p) => <IconBase {...p} d="M18 6L6 18 M6 6l12 12" />;
        const Sparkles = (p) => <IconBase {...p} d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z" />;
        const ListOrdered = (p) => <IconBase {...p} d="M10 6h11M10 12h11M10 18h11M4 6h1M4 12h1M4 18h1" />;
        const Hand = (p) => <IconBase {...p} d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0 M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2 M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8 M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15" />;
        const Move = (p) => <IconBase {...p} d="M5 9l-3 3 3 3M9 5l3-3 3 3M19 9l3 3-3 3M9 19l3 3 3-3M2 12h20M12 2v20" />;
        const Heart = (p) => <IconBase {...p} d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />;
        const Lock = (p) => <IconBase {...p} d="M19 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2Zm-5 0V7a4 4 0 1 0-8 0v4" />;

        // --- Logic: Intent Analysis ---
        const analyzeIntent = (q) => {
            const safeQ = q || "";
            let category = "功名";
            let type = "work";

            if (safeQ.match(/學業|考試|讀書|成績|榜單|轉系|科系|休學|復學|學校|大學|高中|研究所|論文|教授|選修|必修/)) { category = "功名"; type = "study"; } 
            else if (safeQ.match(/另一[伴半]|對象|姻緣|愛|桃花|復合|分手|結婚|曖昧|男友|女友|老公|老婆|夫妻|喜歡/)) { category = "婚姻"; type = "love"; } 
            else if (safeQ.match(/錢|財|投資|股票|生意|買房|債/)) { category = "財利"; type = "wealth"; } 
            else if (safeQ.match(/健康|病|痛|身體|手術|住院|開刀/)) { category = "治病"; type = "health"; } 
            else if (safeQ.match(/工作|求職|事業|面試|公司|老闆|薪水|升遷|履歷|offer|轉職|離職/)) { category = "功名"; type = "work"; }
            
            const nouns = safeQ.match(/(電子書企劃|工程師|業務|對象|另一[伴半]|男朋友|女朋友|老公|老婆|房子|手術|考試|轉系|科系|論文)/);
            let defaultSubject = '這件事';
            if (type === 'study') defaultSubject = '學業前程';
            else if (type === 'work') defaultSubject = '工作發展';
            else if (type === 'love') defaultSubject = '感情緣分';
            else if (type === 'health') defaultSubject = '身體健康';

            const subject = nouns ? nouns[0] : defaultSubject;
            return { category, type, subject };
        };

        const analyzePoemLine = (line, type, isGood) => {
            let meaning = "";
            if (line.match(/日|陽|光|明/)) meaning = "局勢如撥雲見日，逐漸明朗。";
            else if (line.match(/月|夜|暗/)) meaning = "目前處於沈潛期，需靜待時機成熟。";
            else if (line.match(/風|雨|浪|雲/)) meaning = "外在變數較多，需穩住陣腳。";
            else if (line.match(/舟|船/)) meaning = type==='work' ? "職涯如行船，方向比速度重要。" : "需同舟共濟，互相扶持。";
            else if (line.match(/花|木|春/)) meaning = "生機勃勃，是發展的好時機。";
            else if (line.match(/貴人|客/)) meaning = "將有貴人相助，多留意身邊建議。";
            else if (line.match(/守|待|退/)) meaning = "目前宜守不宜攻，安分守己為上。";
            else meaning = isGood ? "順勢而為，自然水到渠成。" : "需多加謹慎，步步為營。";
            return meaning;
        };

        const generateStrategicGuidance = (deity, userName, question, lot) => {
            if (!lot || !lot.j) return "解析中...";
            const { category, type, subject } = analyzeIntent(question);
            
            let judgement = "平平";
            if (deity === 'mazu') judgement = lot.j[category] || "平平";
            else {
                const map = {'治病':'疾病', '尋人':'求謀', '官事':'求謀', '家運':'家宅', '功名':'功名', '婚姻':'婚姻', '財利':'財利'};
                const key = map[category] || '求謀';
                judgement = lot.j[key] || "平平";
            }

            const isGood = ['上上','上吉','中吉','大吉','勝','有','成','顯','癒'].some(k => (lot.l.includes(k) || judgement.includes(k)));
            const godName = deity === 'mazu' ? '媽祖婆' : '黃大仙';

            let text = `信眾 ${userName} 您好，${godName}收到了您關於「${question}」的祈求。\n\n`;

            text += `【典故寓意】\n本籤典故為「${lot.s}」。`;
            text += isGood ? ` 就像故事中的情境，您的誠心感動了上天，事情將有轉機。\n` : ` 目前可能面臨考驗，需如古人般展現智慧與耐心，不宜冒進。\n`;

            text += `\n【籤詩逐句詳解】\n`;
            if (lot.p && Array.isArray(lot.p) && lot.p.length >= 4) {
                lot.p.forEach((line, i) => {
                    text += `${i+1}. 「${line}」：${analyzePoemLine(line, type, isGood)}\n`;
                });
            }

            text += `\n【總結】\n`;
            text += `有利條件：`;
            text += isGood ? `運勢處於上升期，且有貴人運或環境助力。\n` : `雖然目前局勢不明，但保持正向仍可發現轉機，沈潛是為了更好的爆發。\n`;

            text += `主要卡點：`;
            if (lot.p.some(l => l.match(/守|待|暗|雲/)) || !isGood) {
                text += `目前有「等待」或「阻礙」的意象，表示時機未到，外在變數較多。\n`;
            } else {
                text += `需注意驕兵必敗，在順境中更要留意細節，勿掉以輕心。\n`;
            }

            text += `行動建議：\n`;
            if (type === 'work') {
                text += `  短期：${isGood ? '積極表現，爭取機會。' : '完善能力準備，更新履歷。'}\n`;
                text += `  中期：${isGood ? '拓展人脈，尋求升遷。' : '低調行事，蒐集產業資訊。'}\n`;
                text += `  長期：${isGood ? '果斷行動，轉換跑道或創業。' : '選擇合適機會再行動，不急於一時。'}\n`;
            } else if (type === 'study') {
                text += `  短期：${isGood ? '保持作息，穩定發揮。' : '找出弱點，加強基礎。'}\n`;
                text += `  中期：${isGood ? '多與同學討論，切磋精進。' : '請教老師或前輩，突破盲點。'}\n`;
                text += `  長期：${isGood ? '金榜題名，更上一層樓。' : '堅持到底，勤能補拙。'}\n`;
            } else {
                text += `  短期：${isGood ? '主動出擊，表達心意。' : '冷靜觀察，照顧好自己。'}\n`;
                text += `  中期：${isGood ? '深化關係，建立共識。' : '保持距離，觀察對方誠意。'}\n`;
                text += `  長期：${isGood ? '修成正果，圓滿如意。' : '隨順因緣，平安是福。'}\n`;
            }

            text += `時間提醒：${isGood ? '近期若有機會出現，應把握良機，切勿猶豫。' : '目前時機尚未成熟，建議先觀望等待良機。'}`;

            return text;
        };

        // --- Components ---
        const MoonBlock = ({ type, rotateClass, side }) => (
            <div className={`w-24 h-12 relative transition-transform duration-700 ease-out transform-style-3d ${rotateClass}`}>
                <div className={`absolute inset-0 backface-hidden ${type === 1 ? 'z-10' : 'z-0'}`} style={{ transform: type === 1 ? 'rotateX(0deg)' : 'rotateX(180deg)' }}>
                    <svg viewBox="0 0 100 50" className="drop-shadow-lg"><path d="M10,50 Q50,-20 90,50 Z" fill="#b91c1c" stroke="#7f1d1d" strokeWidth="2" /><path d="M20,45 Q50,0 80,45" fill="none" stroke="#991b1b" strokeWidth="1" opacity="0.5" /></svg>
                </div>
                <div className={`absolute inset-0 backface-hidden ${type === 0 ? 'z-10' : 'z-0'}`} style={{ transform: type === 0 ? 'rotateX(0deg)' : 'rotateX(-180deg)' }}>
                    <svg viewBox="0 0 100 50" className="drop-shadow-lg"><path d="M10,50 Q50,-20 90,50 Z" fill="#fca5a5" stroke="#b91c1c" strokeWidth="2" /><path d="M15,48 Q50,-10 85,48 Z" fill="#fee2e2" opacity="0.8" /><text x="50" y="40" fontSize="8" textAnchor="middle" fill="#b91c1c" opacity="0.3">聖</text></svg>
                </div>
            </div>
        );

        function App() {
            const [deity, setDeity] = useState(null); 
            const [step, setStep] = useState(STEPS.INTRO);
            const [userName, setUserName] = useState('');
            const [question, setQuestion] = useState('');
            const [isTossing, setIsTossing] = useState(false);
            const [isResetting, setIsResetting] = useState(false);
            const [beiResult, setBeiResult] = useState('');
            const [leftBeiType, setLeftBeiType] = useState(0); 
            const [rightBeiType, setRightBeiType] = useState(1);
            const [tossCount, setTossCount] = useState(0); 
            const [shakeCount, setShakeCount] = useState(0);
            const [isShakingAnim, setIsShakingAnim] = useState(false); 
            const [tempLot, setTempLot] = useState(null);
            const [message, setMessage] = useState('');
            const [guidanceText, setGuidanceText] = useState('');
            const [generatedImg, setGeneratedImg] = useState(null);
            const [showImgModal, setShowImgModal] = useState(false);
            const canvasRef = useRef(null);
            const [aiText, setAiText] = useState('');

            const resetAll = () => {
                setDeity(null);
                setStep(STEPS.INTRO);
                setUserName('');
                setQuestion('');
                setTempLot(null);
                setMessage('');
                setGuidanceText('');
                setGeneratedImg(null);
                setIsResetting(false);
            };
            
            const reset = () => {
                setStep(STEPS.INPUT); 
                setQuestion('');
                setTempLot(null);
                setMessage('');
                setGuidanceText('');
                setGeneratedImg(null);
                setIsResetting(false);
            };

            const performToss = (onResult) => {
                if (isTossing || isResetting) return;
                setIsTossing(true); setBeiResult(''); setMessage('誠心擲出...'); setTossCount(c => c + 1); 
                setTimeout(() => {
                    const rand = Math.random();
                    let result;
                    if (step === 2) result = rand < 0.7 ? '聖筊' : (rand < 0.85 ? '笑筊' : '陰筊');
                    else result = rand < 0.55 ? '聖筊' : (rand < 0.75 ? '笑筊' : '陰筊');
                    
                    setBeiResult(result); setIsTossing(false);
                    if (result === '聖筊') { setLeftBeiType(0); setRightBeiType(1); }
                    else if (result === '笑筊') { setLeftBeiType(0); setRightBeiType(0); }
                    else { setLeftBeiType(1); setRightBeiType(1); }
                    if (onResult) onResult(result);
                }, 1500);
            };

            const onAskPermission = () => {
                performToss((result) => {
                    if (result === '聖筊') {
                        setMessage(`${deity === 'mazu' ? '媽祖' : '大仙'}答應賜籤，請開始搖籤筒。`);
                        setIsResetting(true); setTimeout(() => { setStep(3); setIsResetting(false); }, 2000);
                    } else {
                        setMessage(`擲出${result}。神明笑而不語或不允，請誠心再試。`);
                    }
                });
            };

            const onShake = () => {
                if (step !== 3 || isShakingAnim) return;
                setIsShakingAnim(true); setShakeCount(c => c + 1); if (navigator.vibrate) navigator.vibrate([30]);
                setTimeout(() => {
                    setIsShakingAnim(false);
                    if (shakeCount >= 5 || (shakeCount > 3 && Math.random() > 0.6)) {
                        const db = deity === 'mazu' ? MAZU_LOTS : WTS_LOTS_FULL;
                        const picked = db[Math.floor(Math.random() * db.length)];
                        setTempLot(picked); setStep(4); setMessage('有一支籤浮出來了！請點擊它抽出。'); setShakeCount(0); 
                    } else { setMessage(`再用力搖一下...`); }
                }, 500);
            };

            const onPickLot = () => { setMessage(`抽出【${deity === 'mazu' ? tempLot.t : tempLot.id}】籤。請擲筊確認。`); setStep(5); };

            const onConfirmLot = () => {
                performToss((result) => {
                    if (result === '聖筊') {
                        setMessage('聖筊！確認是這支籤。');
                        setIsResetting(true); setTimeout(() => { startAiAnalysis(); }, 1500);
                    } else {
                        setMessage(`擲出${result}。神明說不是這支籤，請重新搖籤。`);
                        setIsResetting(true); setTimeout(() => { setTempLot(null); setStep(3); setShakeCount(0); setIsResetting(false); }, 2500);
                    }
                });
            };

            const startAiAnalysis = () => {
                setStep(STEPS.AI_ANALYZING); 
                setIsResetting(false); 
                setMessage('神諭解析中...');
                
                const loadingTexts = ["連結籤詩智慧庫...", "分析您的煩惱...", "推演五行卦象...", "生成戰略總結..."];
                let i = 0;
                setAiText(loadingTexts[0]);
                
                const interval = setInterval(() => {
                    i++;
                    if (i < loadingTexts.length) {
                        setAiText(loadingTexts[i]);
                    } else {
                        clearInterval(interval);
                        setGuidanceText(generateStrategicGuidance(deity, userName, question, tempLot));
                        setStep(STEPS.RESULT);
                    }
                }, 600);
            };

            const generateImage = () => {
                const canvas = canvasRef.current;
                if (!canvas || !tempLot) return;
                const ctx = canvas.getContext('2d');
                const width = 1000;
                
                const ctxDummy = document.createElement('canvas').getContext('2d');
                ctxDummy.font = '28px "Noto Serif TC", serif';
                const padding = 50;
                const contentWidth = width - (padding * 2);
                
                const paragraphs = guidanceText.split('\n');
                let textHeight = 0;
                paragraphs.forEach(p => {
                    let line = '';
                    for(let w of p.split('')) {
                        if(ctxDummy.measureText(line + w).width > contentWidth) { textHeight += 40; line = w; } 
                        else { line += w; }
                    }
                    textHeight += 40; textHeight += 20; 
                });

                const slipHeight = 550;
                const totalHeight = 180 + slipHeight + 50 + 100 + textHeight + 100; 

                canvas.width = width; canvas.height = totalHeight;

                // BG
                ctx.fillStyle = '#fffcf5'; ctx.fillRect(0, 0, width, totalHeight);
                ctx.strokeStyle = '#b91c1c'; ctx.lineWidth = 20; ctx.strokeRect(0, 0, width, totalHeight);
                ctx.strokeStyle = '#d97706'; ctx.lineWidth = 4; ctx.strokeRect(25, 25, width - 50, totalHeight - 50);

                ctx.fillStyle = '#b91c1c'; ctx.textAlign = 'center';
                ctx.font = 'bold 56px "Noto Serif TC", serif'; ctx.fillText(deity === 'mazu' ? '天后宮靈籤' : '黃大仙靈籤', width / 2, 100);

                const slipTopY = 160;
                ctx.fillStyle = '#fff0f0'; ctx.fillRect(padding, slipTopY, width - padding*2, slipHeight);
                ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 4; ctx.strokeRect(padding, slipTopY, width - padding*2, slipHeight);

                ctx.fillStyle = '#991b1b'; ctx.font = 'bold 36px "Noto Serif TC", serif';
                const lotTitle = deity === 'mazu' ? `${tempLot.t}籤` : `第${tempLot.id}籤`;
                ctx.fillText(`${lotTitle} ‧ ${tempLot.l}`, width / 2, slipTopY + 60);
                
                ctx.fillStyle = '#4b5563'; ctx.font = '28px "Noto Serif TC", serif';
                ctx.fillText(`【${tempLot.s}】`, width / 2, slipTopY + 100);

                ctx.fillStyle = '#111827'; ctx.font = 'bold 44px "Noto Serif TC", serif';
                const poemXStart = width / 2 + 150;
                const poemYStart = slipTopY + 160;
                if(tempLot.p) {
                    tempLot.p.forEach((line, i) => {
                        const x = poemXStart - (i * 100);
                        for(let j=0; j<line.length; j++) { ctx.fillText(line[j], x, poemYStart + (j * 60)); }
                    });
                }
                
                // Judgements (Safe Rendering)
                ctx.font = '24px "Noto Serif TC", serif'; ctx.textAlign = 'left';
                const j = tempLot.j || {};
                
                let leftKeys, rightKeys;
                if(deity === 'mazu') {
                    leftKeys = ['功名','月令','婚姻','家運'];
                    rightKeys = ['財利','治病','尋人','官事'];
                } else {
                    leftKeys = ['功名','財利','婚姻','家宅'];
                    rightKeys = ['自身','求謀','疾病','出行'];
                }

                const drawJ = (k, v, x, y) => {
                    ctx.fillStyle = '#7f1d1d'; ctx.fillText(k, x, y);
                    ctx.fillStyle = '#dc2626'; ctx.fillText(v || '平', x + 60, y);
                };

                let jy = slipTopY + 180;
                leftKeys.forEach(k => { drawJ(k, j[k] || '平', padding + 30, jy); jy+=80; });
                jy = slipTopY + 180;
                rightKeys.forEach(k => { drawJ(k, j[k] || '平', width - padding - 150, jy); jy+=80; });

                // Divider
                const dividerY = slipTopY + slipHeight + 40;
                ctx.beginPath(); ctx.moveTo(padding, dividerY); ctx.lineTo(width - padding, dividerY);
                ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke();

                // Guidance
                let cursorY = dividerY + 60;
                ctx.textAlign = 'left';
                ctx.fillStyle = deity === 'mazu' ? '#b91c1c' : '#d97706'; 
                ctx.font = 'bold 32px "Noto Serif TC", serif';
                ctx.fillText(deity === 'mazu' ? '【媽祖的溫暖指引】' : '【大仙機緣指點】', padding, cursorY);
                cursorY += 50;

                ctx.fillStyle = '#374151'; ctx.font = '28px "Noto Serif TC", serif';
                paragraphs.forEach(p => {
                    let line = '';
                    for(let w of p.split('')) {
                        if(ctx.measureText(line + w).width > contentWidth) {
                            ctx.fillText(line, padding, cursorY); line = w; cursorY += 40;
                        } else { line += w; }
                    }
                    ctx.fillText(line, padding, cursorY); cursorY += 60; 
                });

                // Footer
                ctx.textAlign = 'center'; ctx.fillStyle = '#9ca3af'; ctx.font = '20px "Noto Serif TC", serif';
                ctx.fillText('線上靈籤 ‧ 誠心結緣', width / 2, totalHeight - 30);

                try {
                    const url = canvas.toDataURL('image/jpeg', 0.9);
                    setGeneratedImg(url); setShowImgModal(true);
                } catch(e) { console.error(e); }
            };

            if (!deity) {
                return (
                    <div className="min-h-screen bg-stone-900 flex flex-col items-center justify-center p-4">
                        <div className="bg-[url('https://www.transparenttextures.com/patterns/wood-pattern.png')] absolute inset-0 opacity-20"></div>
                        <h1 className="text-4xl font-bold text-yellow-500 mb-8 z-10 tracking-widest drop-shadow-lg">請選擇參拜殿堂</h1>
                        <div className="flex flex-col md:flex-row gap-8 z-10">
                            <button onClick={() => { setDeity('mazu'); setStep(STEPS.INTRO); }} className="group relative bg-red-900/80 border-4 border-yellow-600 rounded-xl p-8 w-64 h-80 flex flex-col items-center justify-center hover:scale-105 transition-all shadow-[0_0_30px_rgba(220,38,38,0.3)]">
                                <div className="absolute inset-0 bg-black/20 group-hover:bg-transparent transition-all rounded-lg"></div>
                                <div className="w-24 h-24 bg-yellow-500 rounded-full flex items-center justify-center mb-6 shadow-lg"><span className="text-4xl font-serif font-bold text-red-900">媽</span></div>
                                <h2 className="text-3xl font-bold text-yellow-100 mb-2">天后宮</h2>
                                <p className="text-yellow-200/60 text-sm">天上聖母 ‧ 溫暖指引</p>
                            </button>
                            <button onClick={() => { setDeity('wongtaisin'); setStep(STEPS.INTRO); }} className="group relative bg-yellow-900/80 border-4 border-yellow-400 rounded-xl p-8 w-64 h-80 flex flex-col items-center justify-center hover:scale-105 transition-all shadow-[0_0_30px_rgba(202,138,4,0.3)]">
                                <div className="absolute inset-0 bg-black/20 group-hover:bg-transparent transition-all rounded-lg"></div>
                                <div className="w-24 h-24 bg-yellow-400 rounded-full flex items-center justify-center mb-6 shadow-lg"><span className="text-4xl font-serif font-bold text-yellow-900">仙</span></div>
                                <h2 className="text-3xl font-bold text-yellow-100 mb-2">黃大仙祠</h2>
                                <p className="text-yellow-200/60 text-sm">有求必應 ‧ 玄機妙算</p>
                            </button>
                        </div>
                        <footer className="mt-12 text-yellow-600/40 text-xs text-center z-10">&copy; 線上靈籤 | 雙神防護版</footer>
                    </div>
                );
            }

            return (
                <div className="flex flex-col items-center justify-center min-h-screen py-6 px-4" style={{"--rotate-end-left": leftBeiType===1?'0deg':'-180deg', "--rotate-end-right": rightBeiType===1?'0deg':'-180deg'}}>
                    <canvas ref={canvasRef} className="hidden" />
                    {showImgModal && generatedImg && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" onClick={() => setShowImgModal(false)}>
                            <div className="bg-white rounded-lg p-4 max-w-sm w-full relative shadow-2xl animate-fade-in" onClick={e => e.stopPropagation()}>
                                <button onClick={() => setShowImgModal(false)} className="absolute -top-3 -right-3 bg-red-600 text-white rounded-full p-1 shadow-lg z-10"><X size={20}/></button>
                                <h3 className="text-red-800 font-bold text-center mb-2 flex items-center justify-center gap-2"><Download size={18}/> 結緣圖已生成</h3>
                                <div className="border-4 border-yellow-500 rounded overflow-hidden mb-3 max-h-[70vh] overflow-y-auto bg-gray-100">
                                    <img src={generatedImg} alt="籤詩結緣圖" className="w-full h-auto" />
                                </div>
                                <p className="text-gray-600 text-sm text-center font-bold bg-yellow-100 p-2 rounded">👆 請長按上方圖片儲存 👆</p>
                            </div>
                        </div>
                    )}

                    <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/wood-pattern.png')] opacity-100 pointer-events-none"></div>
                    
                    <header className="z-10 text-center mb-6 relative">
                        <div className={`${deity === 'mazu' ? 'bg-red-800/90' : 'bg-yellow-800/90'} border-2 border-yellow-500/50 px-8 py-3 rounded-full shadow-lg backdrop-blur-sm`}>
                            <h1 className="text-2xl md:text-3xl font-bold text-yellow-400 tracking-widest flex items-center gap-3">
                                <Star className="text-yellow-400"/> 
                                {deity === 'mazu' ? '天后宮線上靈籤' : '黃大仙線上靈籤'} 
                                <Star className="text-yellow-400"/>
                            </h1>
                        </div>
                    </header>

                    <div className="z-20 min-h-[60px] flex items-center justify-center w-full max-w-md mb-4 px-4">
                        {message && <div className="bg-black/60 border-l-4 border-yellow-500 text-yellow-100 px-6 py-3 rounded-r-lg shadow-lg animate-fade-in">{message}</div>}
                    </div>

                    <main className="z-10 w-full max-w-md flex-1 flex flex-col items-center justify-center relative">
                        {step === STEPS.INTRO && (
                            <div className={`${deity === 'mazu' ? 'bg-red-900/40' : 'bg-yellow-900/40'} backdrop-blur-md p-8 rounded-2xl border border-yellow-500/30 text-center shadow-2xl space-y-8 animate-fade-in`}>
                                <div className={`w-24 h-24 ${deity === 'mazu' ? 'bg-yellow-500' : 'bg-yellow-400'} rounded-full mx-auto flex items-center justify-center shadow-lg ring-4 ring-yellow-600/50`}>
                                    <span className={`text-4xl font-serif font-bold ${deity === 'mazu' ? 'text-red-900' : 'text-yellow-900'}`}>{deity === 'mazu' ? '媽' : '仙'}</span>
                                </div>
                                <div>
                                    <h2 className="text-2xl font-bold text-yellow-200 mb-2">誠心求籤</h2>
                                    <div className="bg-black/30 p-6 rounded-lg text-sm text-gray-200 border border-white/10 text-left">
                                        <p className="flex items-center gap-2 text-yellow-400 mb-4 font-bold text-lg border-b border-yellow-500/50 pb-2"><ListOrdered size={20}/> 虔誠求籤四步驟</p>
                                        <div className="space-y-3">
                                            <div className="flex gap-3"><span className="bg-yellow-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">1</span><p>輸入姓名與祈求事項，誠心默念。</p></div>
                                            <div className="flex gap-3"><span className="bg-yellow-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">2</span><p>擲筊請示神明是否願意賜籤。</p></div>
                                            <div className="flex gap-3"><span className="bg-yellow-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">3</span><p>搖動籤筒直至聖籤浮出。</p></div>
                                            <div className="flex gap-3"><span className="bg-yellow-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">4</span><p>再次擲筊確認，領取籤詩與解讀。</p></div>
                                        </div>
                                    </div>
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={resetAll} className="flex-1 py-3 bg-gray-700 hover:bg-gray-600 text-gray-300 font-bold rounded-lg shadow-lg">返回</button>
                                    <button onClick={() => setStep(STEPS.INPUT)} className="flex-[2] py-3 bg-gradient-to-r from-yellow-600 to-yellow-500 text-red-950 font-bold rounded-lg shadow-lg hover:scale-105 transition-transform">開始參拜</button>
                                </div>
                            </div>
                        )}

                        {step === STEPS.INPUT && (
                            <div className={`${deity === 'mazu' ? 'bg-red-900/60' : 'bg-yellow-900/60'} backdrop-blur p-6 rounded-xl border border-yellow-600/30 shadow-2xl space-y-6 animate-fade-in`}>
                                <h3 className="text-lg font-bold text-yellow-300 text-center border-b border-yellow-600/30 pb-3">稟報資料</h3>
                                <div className="space-y-4">
                                    <div><label className="block text-xs text-yellow-200 mb-1 ml-1">姓名</label><input type="text" value={userName} onChange={e => setUserName(e.target.value)} className="w-full bg-black/30 border border-yellow-700/50 rounded p-3 text-yellow-50 focus:outline-none focus:border-yellow-500 text-white" placeholder="請輸入您的姓名"/></div>
                                    <div><label className="block text-xs text-yellow-200 mb-1 ml-1">祈求事項 (請詳述)</label><textarea value={question} onChange={e => setQuestion(e.target.value)} className="w-full h-40 bg-black/30 border border-yellow-700/50 rounded p-3 text-yellow-50 focus:outline-none focus:border-yellow-500 resize-none text-white" placeholder="例：想轉系到設計系，不知道是否適合？"/></div>
                                </div>
                                <button onClick={() => { if(!userName || !question) { setMessage("請填寫完整以示誠心"); return; } setStep(STEPS.ASK_PERMISSION); setMessage("請默念問題，接著擲筊請示是否賜籤。"); }} className="w-full py-3 bg-yellow-600 hover:bg-yellow-500 text-red-950 font-bold rounded-lg shadow-lg">資料稟報完畢</button>
                            </div>
                        )}

                        {(step === STEPS.ASK_PERMISSION || step === STEPS.CONFIRM_LOT) && (
                            <div className="flex flex-col items-center justify-center w-full h-full pb-10">
                                <div className="relative w-full h-64 flex items-center justify-center gap-12 perspective-1000">
                                    <MoonBlock key={`l-${tossCount}`} type={isTossing?1:leftBeiType} rotateClass={isTossing?'animate-toss-left':''} side="left" />
                                    <MoonBlock key={`r-${tossCount}`} type={isTossing?1:rightBeiType} rotateClass={isTossing?'animate-toss-right':''} side="right" />
                                </div>
                                <div className="h-12 flex items-center justify-center mb-6">{beiResult && !isTossing && <span className="text-3xl font-bold text-yellow-400 animate-bounce">{beiResult}</span>}</div>
                                <button disabled={isTossing || isResetting} onClick={step===STEPS.ASK_PERMISSION ? onAskPermission : onConfirmLot} className={`px-12 py-4 rounded-full font-bold text-xl shadow-lg border-2 transition-all flex items-center gap-2 ${isTossing || isResetting ? 'bg-gray-600 border-gray-500 text-gray-400 cursor-not-allowed' : 'bg-red-600 border-red-400 text-white hover:bg-red-500'}`}>
                                    {(isTossing || isResetting) && <Lock size={18}/>}
                                    {step===STEPS.CONFIRM_LOT?'擲筊確認':'擲筊請示'}
                                </button>
                            </div>
                        )}

                        {(step === STEPS.SHAKING || step === STEPS.PICK_LOT) && (
                            <div className="flex flex-col items-center justify-end h-full pb-12 w-full" onClick={step===STEPS.SHAKING?onShake:undefined}>
                                <div className={`relative w-40 h-64 cursor-pointer select-none ${isShakingAnim ? 'animate-shake-hard' : ''}`}>
                                    <div className="absolute -top-10 left-1/2 transform -translate-x-1/2 w-32 h-64 flex justify-center items-end overflow-hidden z-0">
                                        {[...Array(8)].map((_, i) => (
                                            <div key={i} className="w-3 bg-yellow-200 border border-yellow-700/30 mx-[2px] rounded-t-sm origin-bottom" style={{
                                                height: '100%', 
                                                transform: `translateY(${isShakingAnim ? Math.random() * 20 : 0}px) rotate(${(i-4)*4}deg)`,
                                                transition: 'transform 0.1s'
                                            }}></div>
                                        ))}
                                    </div>
                                    
                                    {step === STEPS.PICK_LOT && (
                                        <div onClick={(e)=>{e.stopPropagation();onPickLot()}} className="absolute -top-32 left-1/2 -translate-x-1/2 w-8 h-64 bg-yellow-100 border-2 border-red-800 rounded-t-md cursor-pointer animate-bounce flex items-center justify-center writing-vertical font-bold text-red-900 z-20 shadow-xl">
                                            {deity === 'wongtaisin' ? tempLot?.id : tempLot?.t}
                                            <div className="absolute -top-10 animate-pulse text-yellow-300 drop-shadow-md"><Hand size={32} className="rotate-180" /></div>
                                        </div>
                                    )}

                                    <div className="absolute bottom-0 w-full h-48 bg-gradient-to-r from-amber-800 via-amber-700 to-amber-900 rounded-b-3xl rounded-t-lg border-4 border-amber-950 shadow-2xl flex items-center justify-center z-10">
                                        <div className="w-24 h-24 border-4 border-amber-900/30 rounded-full flex items-center justify-center opacity-50"><span className="text-4xl font-serif font-bold text-black/40">籤</span></div>
                                    </div>
                                </div>
                                <div className="mt-12 text-center h-20">
                                    {step === STEPS.SHAKING ? (
                                        <><p className="text-yellow-200 text-lg font-bold animate-pulse mb-2">請連續點擊籤筒 ({shakeCount})</p><div className="flex justify-center text-gray-500"><Move size={24} className="animate-wiggle" /></div></>
                                    ) : (<p className="text-yellow-200 text-xl font-bold animate-bounce">請點擊上方浮出的籤支！</p>)}
                                </div>
                            </div>
                        )}

                        {step === STEPS.AI_ANALYZING && (
                            <div className="flex flex-col items-center justify-center h-full animate-fade-in text-center space-y-6">
                                <div className="relative">
                                    <div className="w-24 h-24 rounded-full border-4 border-yellow-500/30 animate-ping absolute inset-0"></div>
                                    <div className="w-24 h-24 rounded-full bg-yellow-500/20 backdrop-blur flex items-center justify-center animate-pulse-glow">
                                        <Heart size={48} className="text-yellow-300 fill-yellow-300" />
                                    </div>
                                </div>
                                <h3 className="text-2xl font-bold text-yellow-200">{aiText}</h3>
                            </div>
                        )}

                        {step === STEPS.RESULT && tempLot && guidanceText && (
                            <div className="w-full h-full flex flex-col animate-fade-in pb-8">
                                <div className="bg-[#fffbf0] text-red-900 rounded-lg p-4 shadow-2xl border-y-8 border-red-800 flex-1 flex flex-col overflow-hidden">
                                    {/* 籤詩 UI (Dynamic based on Deity) */}
                                    <div className="border-4 border-red-800 p-2 mb-2 bg-red-50">
                                        <div className="text-center border-b-2 border-red-200 pb-2 mb-2">
                                             <div className="flex justify-between items-center px-2">
                                                <span className="font-bold text-lg">{deity === 'mazu' ? `${tempLot.t}籤` : `第${tempLot.id}籤`}</span>
                                                <span className="text-sm bg-red-800 text-white px-2 py-1 rounded">{tempLot.l}</span>
                                             </div>
                                             {/* 媽祖顯示第幾籤，黃大仙只顯示ID在標題 */}
                                             {deity === 'mazu' && <p className="text-red-800 font-bold mt-1 text-sm">第 {tempLot.id} 籤</p>}
                                             <p className="text-gray-600 font-serif mt-1 text-sm">【{tempLot.s}】</p>
                                        </div>
                                        <div className="flex">
                                            {/* Left Column */}
                                            <div className="w-1/6 text-xs text-red-900 flex flex-col gap-2 items-center border-r border-red-200 pt-2">
                                                <div><span className="block font-bold">功</span><span className="text-red-600">{tempLot.j ? (tempLot.j.功名 || '平') : '平'}</span></div>
                                                <div><span className="block font-bold">{deity==='mazu'?'月':'財'}</span><span className="text-red-600">{tempLot.j ? (deity==='mazu'?tempLot.j.月令:tempLot.j.財利) : '平'}</span></div>
                                                <div><span className="block font-bold">婚</span><span className="text-red-600">{tempLot.j ? (tempLot.j.婚姻 || '平') : '平'}</span></div>
                                            </div>
                                            {/* Poem */}
                                            <div className="flex-1 flex justify-center items-center py-2">
                                                <div className="flex flex-row-reverse gap-2">
                                                     {tempLot.p && tempLot.p.map((line, idx) => (<div key={idx} className="writing-vertical text-lg font-serif font-bold text-black h-36 border-l border-red-100 pl-1">{line}</div>))}
                                                </div>
                                            </div>
                                            {/* Right Column */}
                                            <div className="w-1/6 text-xs text-red-900 flex flex-col gap-2 items-center border-l border-red-200 pt-2">
                                                <div><span className="block font-bold">{deity==='mazu'?'財':'家'}</span><span className="text-red-600">{tempLot.j ? (deity==='mazu'?tempLot.j.財利:tempLot.j.家宅) : '平'}</span></div>
                                                <div><span className="block font-bold">{deity==='mazu'?'病':'疾'}</span><span className="text-red-600">{tempLot.j ? (deity==='mazu'?tempLot.j.治病:tempLot.j.疾病) : '平'}</span></div>
                                                <div><span className="block font-bold">{deity==='mazu'?'尋':'求'}</span><span className="text-red-600">{tempLot.j ? (deity==='mazu'?tempLot.j.尋人:tempLot.j.求謀) : '平'}</span></div>
                                                <div><span className="block font-bold">{deity==='mazu'?'官':'行'}</span><span className="text-red-600">{tempLot.j ? (deity==='mazu'?tempLot.j.官事:tempLot.j.出行) : '平'}</span></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-white/60 p-3 rounded border border-red-100 text-sm overflow-y-auto flex-1 whitespace-pre-line leading-relaxed text-justify text-gray-900">
                                        {guidanceText}
                                    </div>
                                </div>
                                <div className="mt-4 flex gap-4 justify-center">
                                    <button onClick={generateImage} className="px-6 py-3 bg-yellow-600 hover:bg-yellow-500 text-white rounded-full font-bold shadow-lg flex items-center gap-2"><Download size={18}/> 保存結緣圖</button>
                                    <button onClick={reset} className="px-6 py-3 bg-red-800 hover:bg-red-700 text-yellow-100 rounded-full shadow-lg"><RotateCcw size={18}/></button>
                                </div>
                            </div>
                        )}
                    </main>
                    <footer className="z-10 mt-4 text-yellow-600/40 text-xs text-center">&copy; 線上靈籤 | V34_Ultimate 雙神防護版</footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
